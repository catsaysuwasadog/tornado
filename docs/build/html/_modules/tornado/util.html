

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tornado.util &mdash; Tornado 6.1.dev1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tornado
          

          
          </a>

          
            
            
              <div class="version">
                6.1.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Userâ€™s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webframework.html">Web framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../http.html">HTTP servers and clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">Asynchronous networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coroutine.html">Coroutines and concurrency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integration with other services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tornado</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tornado.util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tornado.util</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Miscellaneous utility functions and classes.</span>

<span class="sd">This module is used internally by Tornado.  It is not necessarily expected</span>
<span class="sd">that the functions and classes defined here will be useful to other</span>
<span class="sd">applications, but they are documented here in case they are.</span>

<span class="sd">The one public-facing part of this module is the `Configurable` class</span>
<span class="sd">and its `~Configurable.configure` method, which becomes a part of the</span>
<span class="sd">interface of its subclasses, including `.AsyncHTTPClient`, `.IOLoop`,</span>
<span class="sd">and `.Resolver`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">getfullargspec</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Match</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># Additional imports only used in type comments.</span>
    <span class="c1"># This lets us make these imports lazy.</span>
    <span class="kn">import</span> <span class="nn">datetime</span>  <span class="c1"># noqa: F401</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">TracebackType</span>  <span class="c1"># noqa: F401</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span>  <span class="c1"># noqa: F401</span>
    <span class="kn">import</span> <span class="nn">unittest</span>  <span class="c1"># noqa: F401</span>

<span class="c1"># Aliases for types that are spelled differently in different Python</span>
<span class="c1"># versions. bytes_type is deprecated and no longer used in Tornado</span>
<span class="c1"># itself but is left in case anyone outside Tornado is using it.</span>
<span class="n">bytes_type</span> <span class="o">=</span> <span class="nb">bytes</span>
<span class="n">unicode_type</span> <span class="o">=</span> <span class="nb">str</span>
<span class="n">basestring_type</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">is_finalizing</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Emulate it</span>
    <span class="k">def</span> <span class="nf">_get_emulated_is_finalizing</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[None]</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">is_finalizing</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="c1"># Not referencing any globals here</span>
            <span class="k">return</span> <span class="n">L</span> <span class="o">!=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">is_finalizing</span>

    <span class="n">is_finalizing</span> <span class="o">=</span> <span class="n">_get_emulated_is_finalizing</span><span class="p">()</span>


<div class="viewcode-block" id="TimeoutError"><a class="viewcode-back" href="../../util.html#tornado.util.TimeoutError">[docs]</a><span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised by `.with_timeout` and `.IOLoop.run_sync`.</span>

<span class="sd">    .. versionchanged:: 5.0:</span>
<span class="sd">       Unified ``tornado.gen.TimeoutError`` and</span>
<span class="sd">       ``tornado.ioloop.TimeoutError`` as ``tornado.util.TimeoutError``.</span>
<span class="sd">       Both former names remain as aliases.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ObjectDict"><a class="viewcode-back" href="../../util.html#tornado.util.ObjectDict">[docs]</a><span class="k">class</span> <span class="nc">ObjectDict</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Makes a dictionary behave like an object, with attribute-style access.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="GzipDecompressor"><a class="viewcode-back" href="../../util.html#tornado.util.GzipDecompressor">[docs]</a><span class="k">class</span> <span class="nc">GzipDecompressor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Streaming gzip decompressor.</span>

<span class="sd">    The interface is like that of `zlib.decompressobj` (without some of the</span>
<span class="sd">    optional arguments, but it understands gzip headers and checksums.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Magic parameter makes zlib module understand gzip header</span>
        <span class="c1"># http://stackoverflow.com/questions/1838699/how-can-i-decompress-a-gzip-stream-with-zlib</span>
        <span class="c1"># This works on cpython and pypy, but not jython.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decompressobj</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">)</span>

<div class="viewcode-block" id="GzipDecompressor.decompress"><a class="viewcode-back" href="../../util.html#tornado.util.GzipDecompressor.decompress">[docs]</a>    <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decompress a chunk, returning newly-available data.</span>

<span class="sd">        Some data may be buffered for later processing; `flush` must</span>
<span class="sd">        be called when there is no more input data to ensure that</span>
<span class="sd">        all data was processed.</span>

<span class="sd">        If ``max_length`` is given, some input data may be left over</span>
<span class="sd">        in ``unconsumed_tail``; you must retrieve this value and pass</span>
<span class="sd">        it back to a future call to `decompress` if it is not empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompressobj</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unconsumed_tail</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the unconsumed portion left over</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompressobj</span><span class="o">.</span><span class="n">unconsumed_tail</span>

<div class="viewcode-block" id="GzipDecompressor.flush"><a class="viewcode-back" href="../../util.html#tornado.util.GzipDecompressor.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return any remaining buffered data not yet returned by decompress.</span>

<span class="sd">        Also checks for errors such as truncated input.</span>
<span class="sd">        No other methods may be called on this object after `flush`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompressobj</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="import_object"><a class="viewcode-back" href="../../util.html#tornado.util.import_object">[docs]</a><span class="k">def</span> <span class="nf">import_object</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Imports an object by name.</span>

<span class="sd">    ``import_object(&#39;x&#39;)`` is equivalent to ``import x``.</span>
<span class="sd">    ``import_object(&#39;x.y.z&#39;)`` is equivalent to ``from x.y import z``.</span>

<span class="sd">    &gt;&gt;&gt; import tornado.escape</span>
<span class="sd">    &gt;&gt;&gt; import_object(&#39;tornado.escape&#39;) is tornado.escape</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; import_object(&#39;tornado.escape.utf8&#39;) is tornado.escape.utf8</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; import_object(&#39;tornado&#39;) is tornado</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; import_object(&#39;tornado.missing_module&#39;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ImportError: No module named missing_module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">exec_in</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">glob</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">loc</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># exec(string) inherits the caller&#39;s future imports; compile</span>
        <span class="c1"># the string first to prevent that.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glob</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">raise_exc_info</span><span class="p">(</span>
    <span class="n">exc_info</span><span class="p">,</span>  <span class="c1"># type: Tuple[Optional[type], Optional[BaseException], Optional[TracebackType]]</span>
<span class="p">):</span>
    <span class="c1"># type: (...) -&gt; typing.NoReturn</span>
    <span class="c1">#</span>
    <span class="c1"># This function&#39;s type annotation must use comments instead of</span>
    <span class="c1"># real annotations because typing.NoReturn does not exist in</span>
    <span class="c1"># python 3.5&#39;s typing module. The formatting is funky because this</span>
    <span class="c1"># is apparently what flake8 wants.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;raise_exc_info called with no exception&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clear the traceback reference from our stack frame to</span>
        <span class="c1"># minimize circular references that slow down GC.</span>
        <span class="n">exc_info</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<div class="viewcode-block" id="errno_from_exception"><a class="viewcode-back" href="../../util.html#tornado.util.errno_from_exception">[docs]</a><span class="k">def</span> <span class="nf">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Provides the errno from an Exception object.</span>

<span class="sd">    There are cases that the errno attribute was not set so we pull</span>
<span class="sd">    the errno out of the args but if someone instantiates an Exception</span>
<span class="sd">    without any args you will get a tuple error. So this function</span>
<span class="sd">    abstracts all that behavior to give you a safe way to get the</span>
<span class="sd">    errno.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;errno&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span>  <span class="c1"># type: ignore</span>
    <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<span class="n">_alphanum</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_re_unescape_replacement</span><span class="p">(</span><span class="n">match</span><span class="p">:</span> <span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_alphanum</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot unescape &#39;</span><span class="se">\\\\</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">group</span>


<span class="n">_re_unescape_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(.)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>


<div class="viewcode-block" id="re_unescape"><a class="viewcode-back" href="../../util.html#tornado.util.re_unescape">[docs]</a><span class="k">def</span> <span class="nf">re_unescape</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Unescape a string escaped by `re.escape`.</span>

<span class="sd">    May raise ``ValueError`` for regular expressions which could not</span>
<span class="sd">    have been produced by `re.escape` (for example, strings containing</span>
<span class="sd">    ``\d`` cannot be unescaped).</span>

<span class="sd">    .. versionadded:: 4.4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_re_unescape_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_re_unescape_replacement</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="Configurable"><a class="viewcode-back" href="../../util.html#tornado.util.Configurable">[docs]</a><span class="k">class</span> <span class="nc">Configurable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for configurable interfaces.</span>

<span class="sd">    A configurable interface is an (abstract) class whose constructor</span>
<span class="sd">    acts as a factory function for one of its implementation subclasses.</span>
<span class="sd">    The implementation subclass as well as optional keyword arguments to</span>
<span class="sd">    its initializer can be set globally at runtime with `configure`.</span>

<span class="sd">    By using the constructor as the factory method, the interface</span>
<span class="sd">    looks like a normal class, `isinstance` works as usual, etc.  This</span>
<span class="sd">    pattern is most useful when the choice of implementation is likely</span>
<span class="sd">    to be a global decision (e.g. when `~select.epoll` is available,</span>
<span class="sd">    always use it instead of `~select.select`), or when a</span>
<span class="sd">    previously-monolithic class has been split into specialized</span>
<span class="sd">    subclasses.</span>

<span class="sd">    Configurable subclasses must define the class methods</span>
<span class="sd">    `configurable_base` and `configurable_default`, and use the instance</span>
<span class="sd">    method `initialize` instead of ``__init__``.</span>

<span class="sd">    .. versionchanged:: 5.0</span>

<span class="sd">       It is now possible for configuration to be specified at</span>
<span class="sd">       multiple levels of a class hierarchy.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Type annotations on this class are mostly done with comments</span>
    <span class="c1"># because they need to refer to Configurable, which isn&#39;t defined</span>
    <span class="c1"># until after the class definition block. These can use regular</span>
    <span class="c1"># annotations when our minimum python version is 3.7.</span>
    <span class="c1">#</span>
    <span class="c1"># There may be a clever way to use generics here to get more</span>
    <span class="c1"># precise types (i.e. for a particular Configurable subclass T,</span>
    <span class="c1"># all the types are subclasses of T, not just Configurable).</span>
    <span class="n">__impl_class</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Type[Configurable]]</span>
    <span class="n">__impl_kwargs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Dict[str, Any]</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span>
        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Any]</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configured_class</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">__impl_kwargs</span><span class="p">:</span>
                <span class="n">init_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">__impl_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="n">init_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">impl</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">base</span><span class="p">:</span>
            <span class="c1"># The impl class is itself configurable, so recurse.</span>
            <span class="k">return</span> <span class="n">impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Configurable</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span>
        <span class="c1"># initialize vs __init__ chosen for compatibility with AsyncHTTPClient</span>
        <span class="c1"># singleton magic.  If we get rid of that we can switch to __init__</span>
        <span class="c1"># here too.</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>

<div class="viewcode-block" id="Configurable.configurable_base"><a class="viewcode-back" href="../../util.html#tornado.util.Configurable.configurable_base">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configurable_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; Type[Configurable]</span>
        <span class="sd">&quot;&quot;&quot;Returns the base class of a configurable hierarchy.</span>

<span class="sd">        This will normally return the class in which it is defined.</span>
<span class="sd">        (which is *not* necessarily the same as the ``cls`` classmethod</span>
<span class="sd">        parameter).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Configurable.configurable_default"><a class="viewcode-back" href="../../util.html#tornado.util.Configurable.configurable_default">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configurable_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; Type[Configurable]</span>
        <span class="sd">&quot;&quot;&quot;Returns the implementation class to be used if none is configured.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">initialize</span> <span class="o">=</span> <span class="n">_initialize</span>  <span class="c1"># type: Callable[..., None]</span>
    <span class="sd">&quot;&quot;&quot;Initialize a `Configurable` subclass instance.</span>

<span class="sd">    Configurable classes should use `initialize` instead of ``__init__``.</span>

<span class="sd">    .. versionchanged:: 4.2</span>
<span class="sd">       Now accepts positional arguments in addition to keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Configurable.configure"><a class="viewcode-back" href="../../util.html#tornado.util.Configurable.configure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># type: (Union[None, str, Type[Configurable]], Any) -&gt; None</span>
        <span class="sd">&quot;&quot;&quot;Sets the class to use when the base class is instantiated.</span>

<span class="sd">        Keyword arguments will be saved and added to the arguments passed</span>
<span class="sd">        to the constructor.  This can be used to set global defaults for</span>
<span class="sd">        some parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">impl</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Type</span><span class="p">[</span><span class="n">Configurable</span><span class="p">],</span> <span class="n">import_object</span><span class="p">(</span><span class="n">impl</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">impl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid subclass of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span> <span class="o">=</span> <span class="n">impl</span>
        <span class="n">base</span><span class="o">.</span><span class="n">__impl_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="Configurable.configured_class"><a class="viewcode-back" href="../../util.html#tornado.util.Configurable.configured_class">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configured_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; Type[Configurable]</span>
        <span class="sd">&quot;&quot;&quot;Returns the currently configured class.&quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span>
        <span class="c1"># Manually mangle the private name to see whether this base</span>
        <span class="c1"># has been configured (and not another base higher in the</span>
        <span class="c1"># hierarchy).</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_Configurable__impl_class&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_default</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should be impossible, but mypy wants an explicit check.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;configured class not found&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_save_configuration</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># type: () -&gt; Tuple[Optional[Type[Configurable]], Dict[str, Any]]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">__impl_kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_restore_configuration</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">saved</span><span class="p">):</span>
        <span class="c1"># type: (Tuple[Optional[Type[Configurable]], Dict[str, Any]]) -&gt; None</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">configurable_base</span><span class="p">()</span>
        <span class="n">base</span><span class="o">.</span><span class="n">__impl_class</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">base</span><span class="o">.</span><span class="n">__impl_kwargs</span> <span class="o">=</span> <span class="n">saved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="ArgReplacer"><a class="viewcode-back" href="../../util.html#tornado.util.ArgReplacer">[docs]</a><span class="k">class</span> <span class="nc">ArgReplacer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replaces one value in an ``args, kwargs`` pair.</span>

<span class="sd">    Inspects the function signature to find an argument by name</span>
<span class="sd">    whether it is passed by position or keyword.  For use in decorators</span>
<span class="sd">    and similar wrappers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getargnames</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># type: Optional[int]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Not a positional parameter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_getargnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;func_code&quot;</span><span class="p">):</span>
                <span class="c1"># Cython-generated code has all the attributes needed</span>
                <span class="c1"># by inspect.getfullargspec, but the inspect module only</span>
                <span class="c1"># works with ordinary functions. Inline the portion of</span>
                <span class="c1"># getfullargspec that we need here. Note that for static</span>
                <span class="c1"># functions the @cython.binding(True) decorator must</span>
                <span class="c1"># be used (for methods it works out of the box).</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">func_code</span>  <span class="c1"># type: ignore</span>
                <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span> <span class="n">code</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">]</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="ArgReplacer.get_old_value"><a class="viewcode-back" href="../../util.html#tornado.util.ArgReplacer.get_old_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_old_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the old value of the named argument without replacing it.</span>

<span class="sd">        Returns ``default`` if the argument is not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArgReplacer.replace"><a class="viewcode-back" href="../../util.html#tornado.util.ArgReplacer.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Replace the named argument in ``args, kwargs`` with ``new_value``.</span>

<span class="sd">        Returns ``(old_value, args, kwargs)``.  The returned ``args`` and</span>
<span class="sd">        ``kwargs`` objects may not be the same as the input objects, or</span>
<span class="sd">        the input objects may be mutated.</span>

<span class="sd">        If the named argument was not found, ``new_value`` will be added</span>
<span class="sd">        to ``kwargs`` and None will be returned as ``old_value``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span><span class="p">:</span>
            <span class="c1"># The arg to replace is passed positionally</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># *args is normally a tuple</span>
            <span class="n">args</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arg_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The arg to replace is either omitted or passed by keyword.</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">return</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span></div></div>


<div class="viewcode-block" id="timedelta_to_seconds"><a class="viewcode-back" href="../../util.html#tornado.util.timedelta_to_seconds">[docs]</a><span class="k">def</span> <span class="nf">timedelta_to_seconds</span><span class="p">(</span><span class="n">td</span><span class="p">):</span>
    <span class="c1"># type: (datetime.timedelta) -&gt; float</span>
    <span class="sd">&quot;&quot;&quot;Equivalent to ``td.total_seconds()`` (introduced in Python 2.7).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">td</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_websocket_mask_python</span><span class="p">(</span><span class="n">mask</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Websocket masking function.</span>

<span class="sd">    `mask` is a `bytes` object of length 4; `data` is a `bytes` object of any length.</span>
<span class="sd">    Returns a `bytes` object of the same length as `data` with the mask applied</span>
<span class="sd">    as specified in section 5.3 of RFC 6455.</span>

<span class="sd">    This pure-python implementation may be replaced by an optimized version when available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_arr</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">unmasked_arr</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">unmasked_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">unmasked_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">mask_arr</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">unmasked_arr</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TORNADO_NO_EXTENSION&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TORNADO_EXTENSION&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
    <span class="c1"># These environment variables exist to make it easier to do performance</span>
    <span class="c1"># comparisons; they are not guaranteed to remain supported in the future.</span>
    <span class="n">_websocket_mask</span> <span class="o">=</span> <span class="n">_websocket_mask_python</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">tornado.speedups</span> <span class="k">import</span> <span class="n">websocket_mask</span> <span class="k">as</span> <span class="n">_websocket_mask</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TORNADO_EXTENSION&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">_websocket_mask</span> <span class="o">=</span> <span class="n">_websocket_mask_python</span>


<span class="k">def</span> <span class="nf">doctests</span><span class="p">():</span>
    <span class="c1"># type: () -&gt; unittest.TestSuite</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="k">return</span> <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestSuite</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The Tornado Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>