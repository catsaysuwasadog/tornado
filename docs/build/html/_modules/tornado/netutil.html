

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tornado.netutil &mdash; Tornado 6.1.dev1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tornado
          

          
          </a>

          
            
            
              <div class="version">
                6.1.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Userâ€™s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webframework.html">Web framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../http.html">HTTP servers and clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">Asynchronous networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coroutine.html">Coroutines and concurrency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integration with other services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tornado</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tornado.netutil</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tornado.netutil</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2011 Facebook</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1"># not use this file except in compliance with the License. You may obtain</span>
<span class="c1"># a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1"># License for the specific language governing permissions and limitations</span>
<span class="c1"># under the License.</span>

<span class="sd">&quot;&quot;&quot;Miscellaneous network utility code.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">stat</span>

<span class="kn">from</span> <span class="nn">tornado.concurrent</span> <span class="k">import</span> <span class="n">dummy_executor</span><span class="p">,</span> <span class="n">run_on_executor</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="k">import</span> <span class="n">IOLoop</span>
<span class="kn">from</span> <span class="nn">tornado.platform.auto</span> <span class="k">import</span> <span class="n">set_close_exec</span>
<span class="kn">from</span> <span class="nn">tornado.util</span> <span class="k">import</span> <span class="n">Configurable</span><span class="p">,</span> <span class="n">errno_from_exception</span>

<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Awaitable</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">asyncio</span> <span class="k">import</span> <span class="n">Future</span>  <span class="c1"># noqa: F401</span>

<span class="c1"># Note that the naming of ssl.Purpose is confusing; the purpose</span>
<span class="c1"># of a context is to authentiate the opposite side of the connection.</span>
<span class="n">_client_ssl_defaults</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
<span class="n">_server_ssl_defaults</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s2">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">):</span>
    <span class="c1"># See netutil.ssl_options_to_context</span>
    <span class="n">_client_ssl_defaults</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>
    <span class="n">_server_ssl_defaults</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>

<span class="c1"># ThreadedResolver runs getaddrinfo on a thread. If the hostname is unicode,</span>
<span class="c1"># getaddrinfo attempts to import encodings.idna. If this is done at</span>
<span class="c1"># module-import time, the import lock is already held by the main thread,</span>
<span class="c1"># leading to deadlock. Avoid it by caching the idna encoder on the main</span>
<span class="c1"># thread now.</span>
<span class="sa">u</span><span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;idna&quot;</span><span class="p">)</span>

<span class="c1"># For undiagnosed reasons, &#39;latin1&#39; codec may also need to be preloaded.</span>
<span class="sa">u</span><span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin1&quot;</span><span class="p">)</span>

<span class="c1"># These errnos indicate that a non-blocking operation must be retried</span>
<span class="c1"># at a later time.  On most platforms they&#39;re the same value, but on</span>
<span class="c1"># some they differ.</span>
<span class="n">_ERRNO_WOULDBLOCK</span> <span class="o">=</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s2">&quot;WSAEWOULDBLOCK&quot;</span><span class="p">):</span>
    <span class="n">_ERRNO_WOULDBLOCK</span> <span class="o">+=</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">WSAEWOULDBLOCK</span><span class="p">,)</span>  <span class="c1"># type: ignore</span>

<span class="c1"># Default backlog used when calling sock.listen()</span>
<span class="n">_DEFAULT_BACKLOG</span> <span class="o">=</span> <span class="mi">128</span>


<div class="viewcode-block" id="bind_sockets"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.bind_sockets">[docs]</a><span class="k">def</span> <span class="nf">bind_sockets</span><span class="p">(</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
    <span class="n">backlog</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_DEFAULT_BACKLOG</span><span class="p">,</span>
    <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reuse_port</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Creates listening sockets bound to the given port and address.</span>

<span class="sd">    Returns a list of socket objects (multiple sockets are returned if</span>
<span class="sd">    the given address maps to multiple IP addresses, which is most common</span>
<span class="sd">    for mixed IPv4 and IPv6 use).</span>

<span class="sd">    Address may be either an IP address or hostname.  If it&#39;s a hostname,</span>
<span class="sd">    the server will listen on all IP addresses associated with the</span>
<span class="sd">    name.  Address may be an empty string or None to listen on all</span>
<span class="sd">    available interfaces.  Family may be set to either `socket.AF_INET`</span>
<span class="sd">    or `socket.AF_INET6` to restrict to IPv4 or IPv6 addresses, otherwise</span>
<span class="sd">    both will be used if available.</span>

<span class="sd">    The ``backlog`` argument has the same meaning as for</span>
<span class="sd">    `socket.listen() &lt;socket.socket.listen&gt;`.</span>

<span class="sd">    ``flags`` is a bitmask of AI_* flags to `~socket.getaddrinfo`, like</span>
<span class="sd">    ``socket.AI_PASSIVE | socket.AI_NUMERICHOST``.</span>

<span class="sd">    ``reuse_port`` option sets ``SO_REUSEPORT`` option for every socket</span>
<span class="sd">    in the list. If your platform doesn&#39;t support this option ValueError will</span>
<span class="sd">    be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reuse_port</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s2">&quot;SO_REUSEPORT&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the platform doesn&#39;t support SO_REUSEPORT&quot;</span><span class="p">)</span>

    <span class="n">sockets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">socket</span><span class="o">.</span><span class="n">has_ipv6</span> <span class="ow">and</span> <span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">:</span>
        <span class="c1"># Python can be compiled with --disable-ipv6, which causes</span>
        <span class="c1"># operations on AF_INET6 sockets to fail, but does not</span>
        <span class="c1"># automatically exclude those results from getaddrinfo</span>
        <span class="c1"># results.</span>
        <span class="c1"># http://bugs.python.org/issue16208</span>
        <span class="n">family</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span>
    <span class="n">bound_port</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unique_addresses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: set</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">unique_addresses</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">unique_addresses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span>
            <span class="ow">and</span> <span class="n">address</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span>
            <span class="ow">and</span> <span class="n">af</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span>
            <span class="ow">and</span> <span class="n">sockaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># Mac OS X includes a link-local address fe80::1%lo0 in the</span>
            <span class="c1"># getaddrinfo results for &#39;localhost&#39;.  However, the firewall</span>
            <span class="c1"># doesn&#39;t understand that this is a local address and will</span>
            <span class="c1"># prompt for access (often repeatedly, due to an apparent</span>
            <span class="c1"># bug in its ability to remember granting access to an</span>
            <span class="c1"># application). Skip these addresses.</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAFNOSUPPORT</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">raise</span>
        <span class="n">set_close_exec</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOPROTOOPT</span><span class="p">:</span>
                    <span class="c1"># Hurd doesn&#39;t support SO_REUSEADDR.</span>
                    <span class="k">raise</span>
        <span class="k">if</span> <span class="n">reuse_port</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">af</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">:</span>
            <span class="c1"># On linux, ipv6 sockets accept ipv4 too by default,</span>
            <span class="c1"># but this makes it impossible to bind to both</span>
            <span class="c1"># 0.0.0.0 in ipv4 and :: in ipv6.  On other systems,</span>
            <span class="c1"># separate sockets *must* be used to listen for both ipv4</span>
            <span class="c1"># and ipv6.  For consistency, always disable ipv4 on our</span>
            <span class="c1"># ipv6 sockets and use a separate ipv4 socket when needed.</span>
            <span class="c1">#</span>
            <span class="c1"># Python 2.x on windows doesn&#39;t have IPPROTO_IPV6.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s2">&quot;IPPROTO_IPV6&quot;</span><span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_V6ONLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># automatic port allocation with port=None</span>
        <span class="c1"># should bind on the same port on IPv4 and IPv6</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">requested_port</span> <span class="o">=</span> <span class="n">sockaddr</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">requested_port</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bound_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sockaddr</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">host</span><span class="p">,</span> <span class="n">bound_port</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">sockaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

        <span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">sockaddr</span><span class="p">)</span>
        <span class="n">bound_port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
        <span class="n">sockets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sockets</span></div>


<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s2">&quot;AF_UNIX&quot;</span><span class="p">):</span>

<div class="viewcode-block" id="bind_unix_socket"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.bind_unix_socket">[docs]</a>    <span class="k">def</span> <span class="nf">bind_unix_socket</span><span class="p">(</span>
        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mo">0o600</span><span class="p">,</span> <span class="n">backlog</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_DEFAULT_BACKLOG</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a listening unix socket.</span>

<span class="sd">        If a socket with the given name already exists, it will be deleted.</span>
<span class="sd">        If any other file with that name exists, an exception will be</span>
<span class="sd">        raised.</span>

<span class="sd">        Returns a socket object (not a list of socket objects like</span>
<span class="sd">        `bind_sockets`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">set_close_exec</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOPROTOOPT</span><span class="p">:</span>
                <span class="c1"># Hurd doesn&#39;t support SO_REUSEADDR</span>
                <span class="k">raise</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISSOCK</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> exists and is not a socket&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sock</span></div>


<div class="viewcode-block" id="add_accept_handler"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.add_accept_handler">[docs]</a><span class="k">def</span> <span class="nf">add_accept_handler</span><span class="p">(</span>
    <span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Adds an `.IOLoop` event handler to accept new connections on ``sock``.</span>

<span class="sd">    When a connection is accepted, ``callback(connection, address)`` will</span>
<span class="sd">    be run (``connection`` is a socket object, and ``address`` is the</span>
<span class="sd">    address of the other end of the connection).  Note that this signature</span>
<span class="sd">    is different from the ``callback(fd, events)`` signature used for</span>
<span class="sd">    `.IOLoop` handlers.</span>

<span class="sd">    A callable is returned which, when called, will remove the `.IOLoop`</span>
<span class="sd">    event handler and stop processing further incoming connections.</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       The ``io_loop`` argument (deprecated since version 4.1) has been removed.</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       A callable is returned (``None`` was returned before).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
    <span class="n">removed</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">accept_handler</span><span class="p">(</span><span class="n">fd</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># More connections may come in while we&#39;re handling callbacks;</span>
        <span class="c1"># to prevent starvation of other tasks we must limit the number</span>
        <span class="c1"># of connections we accept at a time.  Ideally we would accept</span>
        <span class="c1"># up to the number of connections that were waiting when we</span>
        <span class="c1"># entered this method, but this information is not available</span>
        <span class="c1"># (and rearranging this method to call accept() as many times</span>
        <span class="c1"># as possible before running any callbacks would have adverse</span>
        <span class="c1"># effects on load balancing in multiprocess configurations).</span>
        <span class="c1"># Instead, we use the (default) listen backlog as a rough</span>
        <span class="c1"># heuristic for the number of connections we can reasonably</span>
        <span class="c1"># accept at once.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_DEFAULT_BACKLOG</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># The socket was probably closed</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># _ERRNO_WOULDBLOCK indicate we have accepted every</span>
                <span class="c1"># connection that is available.</span>
                <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_ERRNO_WOULDBLOCK</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># ECONNABORTED indicates that there was a connection</span>
                <span class="c1"># but it was closed while still in the accept queue.</span>
                <span class="c1"># (observed on FreeBSD).</span>
                <span class="k">if</span> <span class="n">errno_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNABORTED</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>
            <span class="n">set_close_exec</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_handler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">io_loop</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
        <span class="n">removed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">io_loop</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">accept_handler</span><span class="p">,</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">remove_handler</span></div>


<div class="viewcode-block" id="is_valid_ip"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.is_valid_ip">[docs]</a><span class="k">def</span> <span class="nf">is_valid_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns ``True`` if the given string is a well-formed IP address.</span>

<span class="sd">    Supports IPv4 and IPv6.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
        <span class="c1"># getaddrinfo resolves empty strings to localhost, and truncates</span>
        <span class="c1"># on zero bytes.</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span>
            <span class="n">ip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AI_NUMERICHOST</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">EAI_NONAME</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Resolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.Resolver">[docs]</a><span class="k">class</span> <span class="nc">Resolver</span><span class="p">(</span><span class="n">Configurable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configurable asynchronous DNS resolver interface.</span>

<span class="sd">    By default, a blocking implementation is used (which simply calls</span>
<span class="sd">    `socket.getaddrinfo`).  An alternative implementation can be</span>
<span class="sd">    chosen with the `Resolver.configure &lt;.Configurable.configure&gt;`</span>
<span class="sd">    class method::</span>

<span class="sd">        Resolver.configure(&#39;tornado.netutil.ThreadedResolver&#39;)</span>

<span class="sd">    The implementations of this interface included with Tornado are</span>

<span class="sd">    * `tornado.netutil.DefaultExecutorResolver`</span>
<span class="sd">    * `tornado.netutil.BlockingResolver` (deprecated)</span>
<span class="sd">    * `tornado.netutil.ThreadedResolver` (deprecated)</span>
<span class="sd">    * `tornado.netutil.OverrideResolver`</span>
<span class="sd">    * `tornado.platform.twisted.TwistedResolver`</span>
<span class="sd">    * `tornado.platform.caresresolver.CaresResolver`</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       The default implementation has changed from `BlockingResolver` to</span>
<span class="sd">       `DefaultExecutorResolver`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configurable_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Resolver&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">Resolver</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">configurable_default</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Resolver&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">DefaultExecutorResolver</span>

<div class="viewcode-block" id="Resolver.resolve"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.Resolver.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Resolves an address.</span>

<span class="sd">        The ``host`` argument is a string which may be a hostname or a</span>
<span class="sd">        literal IP address.</span>

<span class="sd">        Returns a `.Future` whose result is a list of (family,</span>
<span class="sd">        address) pairs, where address is a tuple suitable to pass to</span>
<span class="sd">        `socket.connect &lt;socket.socket.connect&gt;` (i.e. a ``(host,</span>
<span class="sd">        port)`` pair for IPv4; additional fields may be present for</span>
<span class="sd">        IPv6). If a ``callback`` is passed, it will be run with the</span>
<span class="sd">        result as an argument when it is complete.</span>

<span class="sd">        :raises IOError: if the address cannot be resolved.</span>

<span class="sd">        .. versionchanged:: 4.4</span>
<span class="sd">           Standardized all implementations to raise `IOError`.</span>

<span class="sd">        .. versionchanged:: 6.0 The ``callback`` argument was removed.</span>
<span class="sd">           Use the returned awaitable object instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resolver.close"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.Resolver.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Closes the `Resolver`, freeing any resources used.</span>

<span class="sd">        .. versionadded:: 3.1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<span class="k">def</span> <span class="nf">_resolve_addr</span><span class="p">(</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="c1"># On Solaris, getaddrinfo fails if the given port is not found</span>
    <span class="c1"># in /etc/services and no socket type is given, so we must pass</span>
    <span class="c1"># one here.  The socket type used here doesn&#39;t seem to actually</span>
    <span class="c1"># matter (we discard the one we get back in the results),</span>
    <span class="c1"># so the addresses we return should still be usable with SOCK_DGRAM.</span>
    <span class="n">addrinfo</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fam</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addrinfo</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fam</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>


<div class="viewcode-block" id="DefaultExecutorResolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.DefaultExecutorResolver">[docs]</a><span class="k">class</span> <span class="nc">DefaultExecutorResolver</span><span class="p">(</span><span class="n">Resolver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resolver implementation using `.IOLoop.run_in_executor`.</span>

<span class="sd">    .. versionadded:: 5.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="n">_resolve_addr</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="ExecutorResolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.ExecutorResolver">[docs]</a><span class="k">class</span> <span class="nc">ExecutorResolver</span><span class="p">(</span><span class="n">Resolver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resolver implementation using a `concurrent.futures.Executor`.</span>

<span class="sd">    Use this instead of `ThreadedResolver` when you require additional</span>
<span class="sd">    control over the executor being used.</span>

<span class="sd">    The executor will be shut down when the resolver is closed unless</span>
<span class="sd">    ``close_resolver=False``; use this if you want to reuse the same</span>
<span class="sd">    executor elsewhere.</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       The ``io_loop`` argument (deprecated since version 4.1) has been removed.</span>

<span class="sd">    .. deprecated:: 5.0</span>
<span class="sd">       The default `Resolver` now uses `.IOLoop.run_in_executor`; use that instead</span>
<span class="sd">       of this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Executor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">close_executor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_executor</span> <span class="o">=</span> <span class="n">close_executor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">dummy_executor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_executor</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_executor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@run_on_executor</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="n">_resolve_addr</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">)</span></div>


<div class="viewcode-block" id="BlockingResolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.BlockingResolver">[docs]</a><span class="k">class</span> <span class="nc">BlockingResolver</span><span class="p">(</span><span class="n">ExecutorResolver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default `Resolver` implementation, using `socket.getaddrinfo`.</span>

<span class="sd">    The `.IOLoop` will be blocked during the resolution, although the</span>
<span class="sd">    callback will not be run until the next `.IOLoop` iteration.</span>

<span class="sd">    .. deprecated:: 5.0</span>
<span class="sd">       The default `Resolver` now uses `.IOLoop.run_in_executor`; use that instead</span>
<span class="sd">       of this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BlockingResolver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span></div>


<div class="viewcode-block" id="ThreadedResolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.ThreadedResolver">[docs]</a><span class="k">class</span> <span class="nc">ThreadedResolver</span><span class="p">(</span><span class="n">ExecutorResolver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multithreaded non-blocking `Resolver` implementation.</span>

<span class="sd">    Requires the `concurrent.futures` package to be installed</span>
<span class="sd">    (available in the standard library since Python 3.2,</span>
<span class="sd">    installable with ``pip install futures`` in older versions).</span>

<span class="sd">    The thread pool size can be configured with::</span>

<span class="sd">        Resolver.configure(&#39;tornado.netutil.ThreadedResolver&#39;,</span>
<span class="sd">                           num_threads=10)</span>

<span class="sd">    .. versionchanged:: 3.1</span>
<span class="sd">       All ``ThreadedResolvers`` share a single thread pool, whose</span>
<span class="sd">       size is set by the first one to be created.</span>

<span class="sd">    .. deprecated:: 5.0</span>
<span class="sd">       The default `Resolver` now uses `.IOLoop.run_in_executor`; use that instead</span>
<span class="sd">       of this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_threadpool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
    <span class="n">_threadpool_pid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: int</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="n">threadpool</span> <span class="o">=</span> <span class="n">ThreadedResolver</span><span class="o">.</span><span class="n">_create_threadpool</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadedResolver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="n">executor</span><span class="o">=</span><span class="n">threadpool</span><span class="p">,</span> <span class="n">close_executor</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_create_threadpool</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool_pid</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">:</span>
            <span class="c1"># Threads cannot survive after a fork, so if our pid isn&#39;t what it</span>
            <span class="c1"># was when we created the pool then delete it.</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">num_threads</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool_pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_threadpool</span></div>


<div class="viewcode-block" id="OverrideResolver"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.OverrideResolver">[docs]</a><span class="k">class</span> <span class="nc">OverrideResolver</span><span class="p">(</span><span class="n">Resolver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a resolver with a mapping of overrides.</span>

<span class="sd">    This can be used to make local DNS changes (e.g. for testing)</span>
<span class="sd">    without modifying system-wide settings.</span>

<span class="sd">    The mapping can be in three formats::</span>

<span class="sd">        {</span>
<span class="sd">            # Hostname to host or ip</span>
<span class="sd">            &quot;example.com&quot;: &quot;127.0.1.1&quot;,</span>

<span class="sd">            # Host+port to host+port</span>
<span class="sd">            (&quot;login.example.com&quot;, 443): (&quot;localhost&quot;, 1443),</span>

<span class="sd">            # Host+port+address family to host+port</span>
<span class="sd">            (&quot;login.example.com&quot;, 443, socket.AF_INET6): (&quot;::1&quot;, 1443),</span>
<span class="sd">        }</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       Added support for host-port-family triplets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">Resolver</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolver</span> <span class="o">=</span> <span class="n">resolver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">family</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AddressFamily</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">host</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span><span class="p">)</span></div>


<span class="c1"># These are the keyword arguments to ssl.wrap_socket that must be translated</span>
<span class="c1"># to their SSLContext equivalents (the other arguments are still passed</span>
<span class="c1"># to SSLContext.wrap_socket).</span>
<span class="n">_SSL_CONTEXT_KEYWORDS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;ssl_version&quot;</span><span class="p">,</span> <span class="s2">&quot;certfile&quot;</span><span class="p">,</span> <span class="s2">&quot;keyfile&quot;</span><span class="p">,</span> <span class="s2">&quot;cert_reqs&quot;</span><span class="p">,</span> <span class="s2">&quot;ca_certs&quot;</span><span class="p">,</span> <span class="s2">&quot;ciphers&quot;</span><span class="p">]</span>
<span class="p">)</span>


<div class="viewcode-block" id="ssl_options_to_context"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.ssl_options_to_context">[docs]</a><span class="k">def</span> <span class="nf">ssl_options_to_context</span><span class="p">(</span>
    <span class="n">ssl_options</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Try to convert an ``ssl_options`` dictionary to an</span>
<span class="sd">    `~ssl.SSLContext` object.</span>

<span class="sd">    The ``ssl_options`` dictionary contains keywords to be passed to</span>
<span class="sd">    `ssl.wrap_socket`.  In Python 2.7.9+, `ssl.SSLContext` objects can</span>
<span class="sd">    be used instead.  This function converts the dict form to its</span>
<span class="sd">    `~ssl.SSLContext` equivalent, and may be used when a component which</span>
<span class="sd">    accepts both forms needs to upgrade to the `~ssl.SSLContext` version</span>
<span class="sd">    to use features like SNI or NPN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_options</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ssl_options</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_options</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">_SSL_CONTEXT_KEYWORDS</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ssl_options</span><span class="p">),</span> <span class="n">ssl_options</span>
    <span class="c1"># Can&#39;t use create_default_context since this interface doesn&#39;t</span>
    <span class="c1"># tell us client vs server.</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_version&quot;</span><span class="p">,</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;certfile&quot;</span> <span class="ow">in</span> <span class="n">ssl_options</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span>
            <span class="n">ssl_options</span><span class="p">[</span><span class="s2">&quot;certfile&quot;</span><span class="p">],</span> <span class="n">ssl_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyfile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;cert_reqs&quot;</span> <span class="ow">in</span> <span class="n">ssl_options</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl_options</span><span class="p">[</span><span class="s2">&quot;cert_reqs&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;ca_certs&quot;</span> <span class="ow">in</span> <span class="n">ssl_options</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">ssl_options</span><span class="p">[</span><span class="s2">&quot;ca_certs&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;ciphers&quot;</span> <span class="ow">in</span> <span class="n">ssl_options</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="n">ssl_options</span><span class="p">[</span><span class="s2">&quot;ciphers&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="s2">&quot;OP_NO_COMPRESSION&quot;</span><span class="p">):</span>
        <span class="c1"># Disable TLS compression to avoid CRIME and related attacks.</span>
        <span class="c1"># This constant depends on openssl version 1.0.</span>
        <span class="c1"># TODO: Do we need to do this ourselves or can we trust</span>
        <span class="c1"># the defaults?</span>
        <span class="n">context</span><span class="o">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">OP_NO_COMPRESSION</span>
    <span class="k">return</span> <span class="n">context</span></div>


<div class="viewcode-block" id="ssl_wrap_socket"><a class="viewcode-back" href="../../netutil.html#tornado.netutil.ssl_wrap_socket">[docs]</a><span class="k">def</span> <span class="nf">ssl_wrap_socket</span><span class="p">(</span>
    <span class="n">socket</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span>
    <span class="n">ssl_options</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">],</span>
    <span class="n">server_hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLSocket</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns an ``ssl.SSLSocket`` wrapping the given socket.</span>

<span class="sd">    ``ssl_options`` may be either an `ssl.SSLContext` object or a</span>
<span class="sd">    dictionary (as accepted by `ssl_options_to_context`).  Additional</span>
<span class="sd">    keyword arguments are passed to ``wrap_socket`` (either the</span>
<span class="sd">    `~ssl.SSLContext` method or the `ssl` module function as</span>
<span class="sd">    appropriate).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl_options_to_context</span><span class="p">(</span><span class="n">ssl_options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ssl</span><span class="o">.</span><span class="n">HAS_SNI</span><span class="p">:</span>
        <span class="c1"># In python 3.4, wrap_socket only accepts the server_hostname</span>
        <span class="c1"># argument if HAS_SNI is true.</span>
        <span class="c1"># TODO: add a unittest (python added server-side SNI support in 3.4)</span>
        <span class="c1"># In the meantime it can be manually tested with</span>
        <span class="c1"># python3 -m tornado.httpclient https://sni.velox.ch</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The Tornado Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>