

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tornado.websocket &mdash; Tornado 6.1.dev1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tornado
          

          
          </a>

          
            
            
              <div class="version">
                6.1.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Userâ€™s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webframework.html">Web framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../http.html">HTTP servers and clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">Asynchronous networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coroutine.html">Coroutines and concurrency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integration with other services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tornado</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tornado.websocket</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tornado.websocket</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implementation of the WebSocket protocol.</span>

<span class="sd">`WebSockets &lt;http://dev.w3.org/html5/websockets/&gt;`_ allow for bidirectional</span>
<span class="sd">communication between the browser and server.</span>

<span class="sd">WebSockets are supported in the current versions of all major browsers,</span>
<span class="sd">although older versions that do not support WebSockets are still in use</span>
<span class="sd">(refer to http://caniuse.com/websockets for details).</span>

<span class="sd">This module implements the final version of the WebSocket protocol as</span>
<span class="sd">defined in `RFC 6455 &lt;http://tools.ietf.org/html/rfc6455&gt;`_.  Certain</span>
<span class="sd">browser versions (notably Safari 5.x) implemented an earlier draft of</span>
<span class="sd">the protocol (known as &quot;draft 76&quot;) and are not compatible with this module.</span>

<span class="sd">.. versionchanged:: 4.0</span>
<span class="sd">   Removed support for the draft 76 protocol version.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">tornado.escape</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlparse</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="kn">from</span> <span class="nn">tornado.concurrent</span> <span class="k">import</span> <span class="n">Future</span><span class="p">,</span> <span class="n">future_set_result_unless_cancelled</span>
<span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="k">import</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">native_str</span><span class="p">,</span> <span class="n">to_unicode</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">gen</span><span class="p">,</span> <span class="n">httpclient</span><span class="p">,</span> <span class="n">httputil</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="k">import</span> <span class="n">IOLoop</span><span class="p">,</span> <span class="n">PeriodicCallback</span>
<span class="kn">from</span> <span class="nn">tornado.iostream</span> <span class="k">import</span> <span class="n">StreamClosedError</span><span class="p">,</span> <span class="n">IOStream</span>
<span class="kn">from</span> <span class="nn">tornado.log</span> <span class="k">import</span> <span class="n">gen_log</span><span class="p">,</span> <span class="n">app_log</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">simple_httpclient</span>
<span class="kn">from</span> <span class="nn">tornado.queues</span> <span class="k">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">tornado.tcpclient</span> <span class="k">import</span> <span class="n">TCPClient</span>
<span class="kn">from</span> <span class="nn">tornado.util</span> <span class="k">import</span> <span class="n">_websocket_mask</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">TracebackType</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="k">import</span> <span class="n">Protocol</span>

    <span class="c1"># The zlib compressor types aren&#39;t actually exposed anywhere</span>
    <span class="c1"># publicly, so declare protocols for the portions we use.</span>
    <span class="k">class</span> <span class="nc">_Compressor</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">class</span> <span class="nc">_Decompressor</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
        <span class="n">unconsumed_tail</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>  <span class="c1"># type: bytes</span>

        <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">class</span> <span class="nc">_WebSocketDelegate</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
        <span class="c1"># The common base interface implemented by WebSocketHandler on</span>
        <span class="c1"># the server side and WebSocketClientConnection on the client</span>
        <span class="c1"># side.</span>
        <span class="k">def</span> <span class="nf">on_ws_connection_close</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">close_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">close_reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Awaitable[None]&quot;</span><span class="p">]:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">on_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">on_pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">log_exception</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">typ</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
            <span class="n">tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="n">_default_max_message_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>


<span class="k">class</span> <span class="nc">WebSocketError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="WebSocketClosedError"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClosedError">[docs]</a><span class="k">class</span> <span class="nc">WebSocketClosedError</span><span class="p">(</span><span class="n">WebSocketError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised by operations on a closed connection.</span>

<span class="sd">    .. versionadded:: 3.2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">_DecompressTooLargeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_WebSocketParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ping_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_message_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_default_max_message_size</span><span class="p">,</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="o">=</span> <span class="n">ping_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping_timeout</span> <span class="o">=</span> <span class="n">ping_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_message_size</span> <span class="o">=</span> <span class="n">max_message_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compression_options</span> <span class="o">=</span> <span class="n">compression_options</span>


<div class="viewcode-block" id="WebSocketHandler"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler">[docs]</a><span class="k">class</span> <span class="nc">WebSocketHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass this class to create a basic WebSocket handler.</span>

<span class="sd">    Override `on_message` to handle incoming messages, and use</span>
<span class="sd">    `write_message` to send messages to the client. You can also</span>
<span class="sd">    override `open` and `on_close` to handle opened and closed</span>
<span class="sd">    connections.</span>

<span class="sd">    Custom upgrade response headers can be sent by overriding</span>
<span class="sd">    `~tornado.web.RequestHandler.set_default_headers` or</span>
<span class="sd">    `~tornado.web.RequestHandler.prepare`.</span>

<span class="sd">    See http://dev.w3.org/html5/websockets/ for details on the</span>
<span class="sd">    JavaScript interface.  The protocol is specified at</span>
<span class="sd">    http://tools.ietf.org/html/rfc6455.</span>

<span class="sd">    Here is an example WebSocket handler that echos back all received messages</span>
<span class="sd">    back to the client:</span>

<span class="sd">    .. testcode::</span>

<span class="sd">      class EchoWebSocket(tornado.websocket.WebSocketHandler):</span>
<span class="sd">          def open(self):</span>
<span class="sd">              print(&quot;WebSocket opened&quot;)</span>

<span class="sd">          def on_message(self, message):</span>
<span class="sd">              self.write_message(u&quot;You said: &quot; + message)</span>

<span class="sd">          def on_close(self):</span>
<span class="sd">              print(&quot;WebSocket closed&quot;)</span>

<span class="sd">    .. testoutput::</span>
<span class="sd">       :hide:</span>

<span class="sd">    WebSockets are not standard HTTP connections. The &quot;handshake&quot; is</span>
<span class="sd">    HTTP, but after the handshake, the protocol is</span>
<span class="sd">    message-based. Consequently, most of the Tornado HTTP facilities</span>
<span class="sd">    are not available in handlers of this type. The only communication</span>
<span class="sd">    methods available to you are `write_message()`, `ping()`, and</span>
<span class="sd">    `close()`. Likewise, your request handler class should implement</span>
<span class="sd">    `open()` method rather than ``get()`` or ``post()``.</span>

<span class="sd">    If you map the handler above to ``/websocket`` in your application, you can</span>
<span class="sd">    invoke it in JavaScript with::</span>

<span class="sd">      var ws = new WebSocket(&quot;ws://localhost:8888/websocket&quot;);</span>
<span class="sd">      ws.onopen = function() {</span>
<span class="sd">         ws.send(&quot;Hello, world&quot;);</span>
<span class="sd">      };</span>
<span class="sd">      ws.onmessage = function (evt) {</span>
<span class="sd">         alert(evt.data);</span>
<span class="sd">      };</span>

<span class="sd">    This script pops up an alert box that says &quot;You said: Hello, world&quot;.</span>

<span class="sd">    Web browsers allow any site to open a websocket connection to any other,</span>
<span class="sd">    instead of using the same-origin policy that governs other network</span>
<span class="sd">    access from javascript.  This can be surprising and is a potential</span>
<span class="sd">    security hole, so since Tornado 4.0 `WebSocketHandler` requires</span>
<span class="sd">    applications that wish to receive cross-origin websockets to opt in</span>
<span class="sd">    by overriding the `~WebSocketHandler.check_origin` method (see that</span>
<span class="sd">    method&#39;s docs for details).  Failure to do so is the most likely</span>
<span class="sd">    cause of 403 errors when making a websocket connection.</span>

<span class="sd">    When using a secure websocket connection (``wss://``) with a self-signed</span>
<span class="sd">    certificate, the connection from a browser may fail because it wants</span>
<span class="sd">    to show the &quot;accept this certificate&quot; dialog but has nowhere to show it.</span>
<span class="sd">    You must first visit a regular HTML page using the same certificate</span>
<span class="sd">    to accept it before the websocket connection will succeed.</span>

<span class="sd">    If the application setting ``websocket_ping_interval`` has a non-zero</span>
<span class="sd">    value, a ping will be sent periodically, and the connection will be</span>
<span class="sd">    closed if a response is not received before the ``websocket_ping_timeout``.</span>

<span class="sd">    Messages larger than the ``websocket_max_message_size`` application setting</span>
<span class="sd">    (default 10MiB) will not be accepted.</span>

<span class="sd">    .. versionchanged:: 4.5</span>
<span class="sd">       Added ``websocket_ping_interval``, ``websocket_ping_timeout``, and</span>
<span class="sd">       ``websocket_max_message_size``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application</span><span class="p">:</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[WebSocketProtocol]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[IOStream]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_close_called</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="c1"># Upgrade header should be present and should be equal to WebSocket</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Upgrade&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;websocket&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;Can &quot;Upgrade&quot; only to &quot;WebSocket&quot;.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Connection header should be upgrade.</span>
        <span class="c1"># Some proxy servers/load balancers</span>
        <span class="c1"># might mess with it.</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;upgrade&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;Connection&quot; must be &quot;Upgrade&quot;.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Handle WebSocket Origin naming convention differences</span>
        <span class="c1"># The difference between version 8 and 13 is that in 8 the</span>
        <span class="c1"># client sends a &quot;Sec-Websocket-Origin&quot; header and in 13 it&#39;s</span>
        <span class="c1"># simply &quot;Origin&quot;.</span>
        <span class="k">if</span> <span class="s2">&quot;Origin&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-Websocket-Origin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># If there was an origin header, check to make sure it matches</span>
        <span class="c1"># according to check_origin. When the origin is None, we assume it</span>
        <span class="c1"># did not come from a browser and that it can be passed on.</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;Cross origin websockets not allowed&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_websocket_protocol</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">accept_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">426</span><span class="p">,</span> <span class="s2">&quot;Upgrade Required&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Version&quot;</span><span class="p">,</span> <span class="s2">&quot;7, 8, 13&quot;</span><span class="p">)</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ping_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The interval for websocket keep-alive pings.</span>

<span class="sd">        Set websocket_ping_interval = 0 to disable pings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;websocket_ping_interval&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ping_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;If no ping is received in this many seconds,</span>
<span class="sd">        close the websocket connection (VPNs, etc. can fail to cleanly close ws connections).</span>
<span class="sd">        Default is max of 3 pings or 30 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;websocket_ping_timeout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_message_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maximum allowed message size.</span>

<span class="sd">        If the remote peer sends a message larger than this, the connection</span>
<span class="sd">        will be closed.</span>

<span class="sd">        Default is 10MiB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;websocket_max_message_size&quot;</span><span class="p">,</span> <span class="n">_default_max_message_size</span>
        <span class="p">)</span>

<div class="viewcode-block" id="WebSocketHandler.write_message"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.write_message">[docs]</a>    <span class="k">def</span> <span class="nf">write_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">binary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Future[None]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends the given message to the client of this Web Socket.</span>

<span class="sd">        The message may be either a string or a dict (which will be</span>
<span class="sd">        encoded as json).  If the ``binary`` argument is false, the</span>
<span class="sd">        message will be sent as utf8; in binary mode any byte string</span>
<span class="sd">        is allowed.</span>

<span class="sd">        If the connection is already closed, raises `WebSocketClosedError`.</span>
<span class="sd">        Returns a `.Future` which can be used for flow control.</span>

<span class="sd">        .. versionchanged:: 3.2</span>
<span class="sd">           `WebSocketClosedError` was added (previously a closed connection</span>
<span class="sd">           would raise an `AttributeError`)</span>

<span class="sd">        .. versionchanged:: 4.3</span>
<span class="sd">           Returns a `.Future` which can be used for flow control.</span>

<span class="sd">        .. versionchanged:: 5.0</span>
<span class="sd">           Consistently raises `WebSocketClosedError`. Previously could</span>
<span class="sd">           sometimes raise `.StreamClosedError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">is_closing</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">WebSocketClosedError</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketHandler.select_subprotocol"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.select_subprotocol">[docs]</a>    <span class="k">def</span> <span class="nf">select_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subprotocols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Override to implement subprotocol negotiation.</span>

<span class="sd">        ``subprotocols`` is a list of strings identifying the</span>
<span class="sd">        subprotocols proposed by the client.  This method may be</span>
<span class="sd">        overridden to return one of those strings to select it, or</span>
<span class="sd">        ``None`` to not select a subprotocol.</span>

<span class="sd">        Failure to select a subprotocol does not automatically abort</span>
<span class="sd">        the connection, although clients may close the connection if</span>
<span class="sd">        none of their proposed subprotocols was selected.</span>

<span class="sd">        The list may be empty, in which case this method must return</span>
<span class="sd">        None. This method is always called exactly once even if no</span>
<span class="sd">        subprotocols were proposed so that the handler can be advised</span>
<span class="sd">        of this fact.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           Previously, this method was called with a list containing</span>
<span class="sd">           an empty string instead of an empty list if no subprotocols</span>
<span class="sd">           were proposed by the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The subprotocol returned by `select_subprotocol`.</span>

<span class="sd">        .. versionadded:: 5.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">selected_subprotocol</span>

<div class="viewcode-block" id="WebSocketHandler.get_compression_options"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.get_compression_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_compression_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Override to return compression options for the connection.</span>

<span class="sd">        If this method returns None (the default), compression will</span>
<span class="sd">        be disabled.  If it returns a dict (even an empty one), it</span>
<span class="sd">        will be enabled.  The contents of the dict may be used to</span>
<span class="sd">        control the following compression options:</span>

<span class="sd">        ``compression_level`` specifies the compression level.</span>

<span class="sd">        ``mem_level`` specifies the amount of memory used for the internal compression state.</span>

<span class="sd">         These parameters are documented in details here:</span>
<span class="sd">         https://docs.python.org/3.6/library/zlib.html#zlib.compressobj</span>

<span class="sd">        .. versionadded:: 4.1</span>

<span class="sd">        .. versionchanged:: 4.5</span>

<span class="sd">           Added ``compression_level`` and ``mem_level``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add wbits option.</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="WebSocketHandler.open"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Invoked when a new WebSocket is opened.</span>

<span class="sd">        The arguments to `open` are extracted from the `tornado.web.URLSpec`</span>
<span class="sd">        regular expression, just like the arguments to</span>
<span class="sd">        `tornado.web.RequestHandler.get`.</span>

<span class="sd">        `open` may be a coroutine. `on_message` will not be called until</span>
<span class="sd">        `open` has returned.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           ``open`` may be a coroutine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="WebSocketHandler.on_message"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Handle incoming messages on the WebSocket</span>

<span class="sd">        This method must be overridden.</span>

<span class="sd">        .. versionchanged:: 4.5</span>

<span class="sd">           ``on_message`` can be a coroutine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="WebSocketHandler.ping"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.ping">[docs]</a>    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send ping frame to the remote end.</span>

<span class="sd">        The data argument allows a small amount of data (up to 125</span>
<span class="sd">        bytes) to be sent as a part of the ping message. Note that not</span>
<span class="sd">        all websocket implementations expose this data to</span>
<span class="sd">        applications.</span>

<span class="sd">        Consider using the ``websocket_ping_interval`` application</span>
<span class="sd">        setting instead of sending pings manually.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           The data argument is now optional.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">is_closing</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">WebSocketClosedError</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">write_ping</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketHandler.on_pong"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.on_pong">[docs]</a>    <span class="k">def</span> <span class="nf">on_pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Invoked when the response to a ping frame is received.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="WebSocketHandler.on_ping"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.on_ping">[docs]</a>    <span class="k">def</span> <span class="nf">on_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Invoked when the a ping frame is received.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="WebSocketHandler.on_close"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Invoked when the WebSocket is closed.</span>

<span class="sd">        If the connection was closed cleanly and a status code or reason</span>
<span class="sd">        phrase was supplied, these values will be available as the attributes</span>
<span class="sd">        ``self.close_code`` and ``self.close_reason``.</span>

<span class="sd">        .. versionchanged:: 4.0</span>

<span class="sd">           Added ``close_code`` and ``close_reason`` attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="WebSocketHandler.close"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Closes this Web Socket.</span>

<span class="sd">        Once the close handshake is successful the socket will be closed.</span>

<span class="sd">        ``code`` may be a numeric status code, taken from the values</span>
<span class="sd">        defined in `RFC 6455 section 7.4.1</span>
<span class="sd">        &lt;https://tools.ietf.org/html/rfc6455#section-7.4.1&gt;`_.</span>
<span class="sd">        ``reason`` may be a textual message about why the connection is</span>
<span class="sd">        closing.  These values are made available to the client, but are</span>
<span class="sd">        not otherwise interpreted by the websocket protocol.</span>

<span class="sd">        .. versionchanged:: 4.0</span>

<span class="sd">           Added the ``code`` and ``reason`` arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="WebSocketHandler.check_origin"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.check_origin">[docs]</a>    <span class="k">def</span> <span class="nf">check_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override to enable support for allowing alternate origins.</span>

<span class="sd">        The ``origin`` argument is the value of the ``Origin`` HTTP</span>
<span class="sd">        header, the url responsible for initiating this request.  This</span>
<span class="sd">        method is not called for clients that do not send this header;</span>
<span class="sd">        such requests are always allowed (because all browsers that</span>
<span class="sd">        implement WebSockets support this header, and non-browser</span>
<span class="sd">        clients do not have the same cross-site security concerns).</span>

<span class="sd">        Should return ``True`` to accept the request or ``False`` to</span>
<span class="sd">        reject it. By default, rejects all requests with an origin on</span>
<span class="sd">        a host other than this one.</span>

<span class="sd">        This is a security protection against cross site scripting attacks on</span>
<span class="sd">        browsers, since WebSockets are allowed to bypass the usual same-origin</span>
<span class="sd">        policies and don&#39;t use CORS headers.</span>

<span class="sd">        .. warning::</span>

<span class="sd">           This is an important security measure; don&#39;t disable it</span>
<span class="sd">           without understanding the security implications. In</span>
<span class="sd">           particular, if your authentication is cookie-based, you</span>
<span class="sd">           must either restrict the origins allowed by</span>
<span class="sd">           ``check_origin()`` or implement your own XSRF-like</span>
<span class="sd">           protection for websocket connections. See `these</span>
<span class="sd">           &lt;https://www.christian-schneider.net/CrossSiteWebSocketHijacking.html&gt;`_</span>
<span class="sd">           `articles</span>
<span class="sd">           &lt;https://devcenter.heroku.com/articles/websocket-security&gt;`_</span>
<span class="sd">           for more.</span>

<span class="sd">        To accept all cross-origin traffic (which was the default prior to</span>
<span class="sd">        Tornado 4.0), simply override this method to always return ``True``::</span>

<span class="sd">            def check_origin(self, origin):</span>
<span class="sd">                return True</span>

<span class="sd">        To allow connections from any subdomain of your site, you might</span>
<span class="sd">        do something like::</span>

<span class="sd">            def check_origin(self, origin):</span>
<span class="sd">                parsed_origin = urllib.parse.urlparse(origin)</span>
<span class="sd">                return parsed_origin.netloc.endswith(&quot;.mydomain.com&quot;)</span>

<span class="sd">        .. versionadded:: 4.0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed_origin</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">parsed_origin</span><span class="o">.</span><span class="n">netloc</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Host&quot;</span><span class="p">)</span>

        <span class="c1"># Check to see that origin matches host directly, including ports</span>
        <span class="k">return</span> <span class="n">origin</span> <span class="o">==</span> <span class="n">host</span></div>

<div class="viewcode-block" id="WebSocketHandler.set_nodelay"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketHandler.set_nodelay">[docs]</a>    <span class="k">def</span> <span class="nf">set_nodelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the no-delay flag for this stream.</span>

<span class="sd">        By default, small messages may be delayed and/or combined to minimize</span>
<span class="sd">        the number of packets sent.  This can sometimes cause 200-500ms delays</span>
<span class="sd">        due to the interaction between Nagle&#39;s algorithm and TCP delayed</span>
<span class="sd">        ACKs.  To reduce this delay (at the expense of possibly increasing</span>
<span class="sd">        bandwidth usage), call ``self.set_nodelay(True)`` once the websocket</span>
<span class="sd">        connection is established.</span>

<span class="sd">        See `.BaseIOStream.set_nodelay` for additional details.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">set_nodelay</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_close_called</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_close_called</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_break_cycles</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_ws_connection_close</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">close_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">close_reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="n">close_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="n">close_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_break_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># WebSocketHandlers call finish() early, but we don&#39;t want to</span>
        <span class="c1"># break up reference cycles (which makes it impossible to call</span>
        <span class="c1"># self.render_string) until after we&#39;ve really closed the</span>
        <span class="c1"># connection (if it was established in the first place,</span>
        <span class="c1"># indicated by status code 101).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">101</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_close_called</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_break_cycles</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we get an uncaught exception during the handshake,</span>
            <span class="c1"># we have no choice but to abruptly close the connection.</span>
            <span class="c1"># TODO: for uncaught exceptions after the handshake,</span>
            <span class="c1"># we can close the connection more gracefully.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_websocket_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;WebSocketProtocol&quot;</span><span class="p">]:</span>
        <span class="n">websocket_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Version&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">websocket_version</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;13&quot;</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">_WebSocketParams</span><span class="p">(</span>
                <span class="n">ping_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span><span class="p">,</span>
                <span class="n">ping_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ping_timeout</span><span class="p">,</span>
                <span class="n">max_message_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_message_size</span><span class="p">,</span>
                <span class="n">compression_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_compression_options</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">WebSocketProtocol13</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_detach_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IOStream</span><span class="p">:</span>
        <span class="c1"># disable non-WS methods</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;write&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redirect&quot;</span><span class="p">,</span>
            <span class="s2">&quot;set_header&quot;</span><span class="p">,</span>
            <span class="s2">&quot;set_cookie&quot;</span><span class="p">,</span>
            <span class="s2">&quot;set_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flush&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finish&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">_raise_not_supported_for_websockets</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_raise_not_supported_for_websockets</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Method not supported for Web Sockets&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WebSocketProtocol</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for WebSocket protocol versions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="s2">&quot;_WebSocketDelegate&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[IOStream]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_terminated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_run_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Optional[Future[Any]]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Runs the given callback with exception handling.</span>

<span class="sd">        If the callback is a coroutine, returns its Future. On error, aborts the</span>
<span class="sd">        websocket connection and returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">log_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">convert_yielded</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantly aborts the WebSocket connection by closing the socket&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_terminated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># forcibly tear down the connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># let the subclass cleanup</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">is_closing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">accept_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">WebSocketHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">write_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">binary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Future[None]&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">selected_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">write_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="c1"># The entry points below are used by WebSocketClientConnection,</span>
    <span class="c1"># which was introduced after we only supported a single version of</span>
    <span class="c1"># WebSocketProtocol. The WebSocketProtocol/WebSocketProtocol13</span>
    <span class="c1"># boundary is currently pretty ad-hoc.</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_process_server_headers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">start_pinging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_receive_frame_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">set_nodelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_PerMessageDeflateCompressor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">persistent</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">max_wbits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_wbits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_wbits</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span>
        <span class="c1"># There is no symbolic constant for the minimum wbits value.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;=</span> <span class="n">max_wbits</span> <span class="o">&lt;=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid max_wbits value </span><span class="si">%r</span><span class="s2">; allowed range 8-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">max_wbits</span><span class="p">,</span>
                <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_wbits</span> <span class="o">=</span> <span class="n">max_wbits</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">compression_options</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="s2">&quot;compression_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compression_options</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compression_level</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">GZipContentEncoding</span><span class="o">.</span><span class="n">GZIP_LEVEL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compression_level</span> <span class="o">=</span> <span class="n">compression_options</span><span class="p">[</span><span class="s2">&quot;compression_level&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">compression_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;mem_level&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compression_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mem_level</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mem_level</span> <span class="o">=</span> <span class="n">compression_options</span><span class="p">[</span><span class="s2">&quot;mem_level&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">persistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_compressor</span><span class="p">()</span>  <span class="c1"># type: Optional[_Compressor]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_create_compressor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_Compressor&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compression_level</span><span class="p">,</span> <span class="n">zlib</span><span class="o">.</span><span class="n">DEFLATED</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wbits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mem_level</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">compressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_compressor</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">compressor</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">Z_SYNC_FLUSH</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x00\xff\xff</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_PerMessageDeflateDecompressor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">persistent</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">max_wbits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">max_message_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_message_size</span> <span class="o">=</span> <span class="n">max_message_size</span>
        <span class="k">if</span> <span class="n">max_wbits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_wbits</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;=</span> <span class="n">max_wbits</span> <span class="o">&lt;=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid max_wbits value </span><span class="si">%r</span><span class="s2">; allowed range 8-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">max_wbits</span><span class="p">,</span>
                <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_wbits</span> <span class="o">=</span> <span class="n">max_wbits</span>
        <span class="k">if</span> <span class="n">persistent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_decompressor</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># type: Optional[_Decompressor]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_create_decompressor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_Decompressor&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_wbits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">decompressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_decompressor</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">decompressor</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span>
            <span class="n">data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x00\xff\xff</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_message_size</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">decompressor</span><span class="o">.</span><span class="n">unconsumed_tail</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_DecompressTooLargeError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">WebSocketProtocol13</span><span class="p">(</span><span class="n">WebSocketProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implementation of the WebSocket protocol from RFC 6455.</span>

<span class="sd">    This class supports versions 7 and 8 of the protocol in addition to the</span>
<span class="sd">    final version 13.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bit masks for the first byte of a frame.</span>
    <span class="n">FIN</span> <span class="o">=</span> <span class="mh">0x80</span>
    <span class="n">RSV1</span> <span class="o">=</span> <span class="mh">0x40</span>
    <span class="n">RSV2</span> <span class="o">=</span> <span class="mh">0x20</span>
    <span class="n">RSV3</span> <span class="o">=</span> <span class="mh">0x10</span>
    <span class="n">RSV_MASK</span> <span class="o">=</span> <span class="n">RSV1</span> <span class="o">|</span> <span class="n">RSV2</span> <span class="o">|</span> <span class="n">RSV3</span>
    <span class="n">OPCODE_MASK</span> <span class="o">=</span> <span class="mh">0x0F</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: IOStream</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">:</span> <span class="s2">&quot;_WebSocketDelegate&quot;</span><span class="p">,</span>
        <span class="n">mask_outgoing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">_WebSocketParams</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">WebSocketProtocol</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_outgoing</span> <span class="o">=</span> <span class="n">mask_outgoing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_frame</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_opcode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masked_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_mask</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[bytes]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[bytes]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_opcode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compression_options</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">compression_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[_PerMessageDeflateDecompressor]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[_PerMessageDeflateCompressor]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_compressed</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[bool]</span>
        <span class="c1"># The total uncompressed size of all messages received or sent.</span>
        <span class="c1"># Unicode messages are encoded to utf8.</span>
        <span class="c1"># Only for testing; subject to change.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_bytes_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_bytes_out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># The total size of all packets received or sent.  Includes</span>
        <span class="c1"># the effect of compression, frame overhead, and control frames.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wire_bytes_in</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wire_bytes_out</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[PeriodicCallback]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ping</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pong</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>

    <span class="c1"># Use a property for this to satisfy the abc.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_subprotocol</span>

    <span class="nd">@selected_subprotocol</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">selected_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_subprotocol</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">accept_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">WebSocketHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_websocket_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;Missing/Invalid WebSocket headers&quot;</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accept_connection</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Malformed WebSocket request received&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_handle_websocket_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">WebSocketHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verifies all invariant- and required headers</span>

<span class="sd">        If a header is missing or have an incorrect value ValueError will be</span>
<span class="sd">        raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="s2">&quot;Sec-Websocket-Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Sec-Websocket-Version&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">fields</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing/Invalid WebSocket headers&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_accept_value</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Computes the value for the Sec-WebSocket-Accept header,</span>
<span class="sd">        given the value for Sec-WebSocket-Key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sha1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">sha1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span><span class="p">)</span>  <span class="c1"># Magic value</span>
        <span class="k">return</span> <span class="n">native_str</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">sha1</span><span class="o">.</span><span class="n">digest</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_challenge_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">WebSocketHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">WebSocketProtocol13</span><span class="o">.</span><span class="n">compute_accept_value</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-Websocket-Key&quot;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_accept_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">WebSocketHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subprotocol_header</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Protocol&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subprotocol_header</span><span class="p">:</span>
            <span class="n">subprotocols</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subprotocol_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subprotocols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selected_subprotocol</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">select_subprotocol</span><span class="p">(</span><span class="n">subprotocols</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_subprotocol</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_subprotocol</span> <span class="ow">in</span> <span class="n">subprotocols</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Protocol&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_subprotocol</span><span class="p">)</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_extensions_header</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;permessage-deflate&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># TODO: negotiate parameters if compression_options</span>
                <span class="c1"># specifies limits.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_compressors</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression_options</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;client_max_window_bits&quot;</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;client_max_window_bits&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="c1"># Don&#39;t echo an offered client_max_window_bits</span>
                    <span class="c1"># parameter with no value.</span>
                    <span class="k">del</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;client_max_window_bits&quot;</span><span class="p">]</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span>
                    <span class="s2">&quot;Sec-WebSocket-Extensions&quot;</span><span class="p">,</span>
                    <span class="n">httputil</span><span class="o">.</span><span class="n">_encode_header</span><span class="p">(</span><span class="s2">&quot;permessage-deflate&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="k">break</span>

        <span class="n">handler</span><span class="o">.</span><span class="n">clear_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Upgrade&quot;</span><span class="p">,</span> <span class="s2">&quot;websocket&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;Upgrade&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Accept&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_challenge_response</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">_detach_stream</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_pinging</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">open_result</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="o">.</span><span class="n">open_args</span><span class="p">,</span> <span class="o">**</span><span class="n">handler</span><span class="o">.</span><span class="n">open_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">open_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">open_result</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">log_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_frame_loop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_extensions_header</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Extensions&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">httputil</span><span class="o">.</span><span class="n">_parse_header</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extensions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_process_server_headers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process the headers sent by the server to this client connection.</span>

<span class="sd">        &#39;key&#39; is the websocket handshake challenge/response key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Upgrade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;websocket&quot;</span>
        <span class="k">assert</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Connection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;upgrade&quot;</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_accept_value</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Sec-Websocket-Accept&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">accept</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_extensions_header</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;permessage-deflate&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_compressors</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported extension </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selected_subprotocol</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sec-WebSocket-Protocol&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_compressor_options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">agreed_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts a websocket agreed_parameters set to keyword arguments</span>
<span class="sd">        for our compressor objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">persistent</span><span class="o">=</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot;_no_context_takeover&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agreed_parameters</span>
        <span class="p">)</span>  <span class="c1"># type: Dict[str, Any]</span>
        <span class="n">wbits_header</span> <span class="o">=</span> <span class="n">agreed_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot;_max_window_bits&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wbits_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_wbits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_wbits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wbits_header</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;compression_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compression_options</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">_create_compressors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">agreed_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO: handle invalid parameters gracefully</span>
        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;server_no_context_takeover&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client_no_context_takeover&quot;</span><span class="p">,</span>
                <span class="s2">&quot;server_max_window_bits&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client_max_window_bits&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">agreed_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported compression parameter </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">other_side</span> <span class="o">=</span> <span class="s2">&quot;client&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;server&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;server&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span> <span class="o">=</span> <span class="n">_PerMessageDeflateCompressor</span><span class="p">(</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_compressor_options</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">agreed_parameters</span><span class="p">,</span> <span class="n">compression_options</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="o">=</span> <span class="n">_PerMessageDeflateDecompressor</span><span class="p">(</span>
            <span class="n">max_message_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_message_size</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_compressor_options</span><span class="p">(</span>
                <span class="n">other_side</span><span class="p">,</span> <span class="n">agreed_parameters</span><span class="p">,</span> <span class="n">compression_options</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_frame</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fin</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">opcode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Future[None]&quot;</span><span class="p">:</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">:</span>
            <span class="c1"># All control frames MUST have a payload length of 125</span>
            <span class="c1"># bytes or less and MUST NOT be fragmented.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fin</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;control frames may not be fragmented&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">125</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;control frame payloads may not exceed 125 bytes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">finbit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finbit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">finbit</span> <span class="o">|</span> <span class="n">opcode</span> <span class="o">|</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_outgoing</span><span class="p">:</span>
            <span class="n">mask_bit</span> <span class="o">=</span> <span class="mh">0x80</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_bit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">126</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">|</span> <span class="n">mask_bit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_len</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;!BH&quot;</span><span class="p">,</span> <span class="mi">126</span> <span class="o">|</span> <span class="n">mask_bit</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;!BQ&quot;</span><span class="p">,</span> <span class="mi">127</span> <span class="o">|</span> <span class="n">mask_bit</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_outgoing</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">_websocket_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wire_bytes_out</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">binary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Future[None]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends the given message to the client of this Web Socket.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
            <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opcode</span> <span class="o">=</span> <span class="mh">0x1</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_bytes_out</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressor</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RSV1</span>
        <span class="c1"># For historical reasons, write methods in Tornado operate in a semi-synchronous</span>
        <span class="c1"># mode in which awaiting the Future they return is optional (But errors can</span>
        <span class="c1"># still be raised). This requires us to go through an awkward dance here</span>
        <span class="c1"># to transform the errors that may be returned while presenting the same</span>
        <span class="c1"># semi-synchronous interface.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">StreamClosedError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WebSocketClosedError</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">fut</span>
            <span class="k">except</span> <span class="n">StreamClosedError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WebSocketClosedError</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">wrapper</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">write_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send ping frame.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_receive_frame_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receive_frame</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">StreamClosedError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_ws_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_read_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wire_bytes_in</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_receive_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Read the frame header.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">mask_payloadlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;BB&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">is_final_frame</span> <span class="o">=</span> <span class="n">header</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIN</span>
        <span class="n">reserved_bits</span> <span class="o">=</span> <span class="n">header</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">RSV_MASK</span>
        <span class="n">opcode</span> <span class="o">=</span> <span class="n">header</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPCODE_MASK</span>
        <span class="n">opcode_is_control</span> <span class="o">=</span> <span class="n">opcode</span> <span class="o">&amp;</span> <span class="mh">0x8</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Compression flag is present in the first frame&#39;s header,</span>
            <span class="c1"># but we can&#39;t decompress until we have all the frames of</span>
            <span class="c1"># the message.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_compressed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">reserved_bits</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">RSV1</span><span class="p">)</span>
            <span class="n">reserved_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">RSV1</span>
        <span class="k">if</span> <span class="n">reserved_bits</span><span class="p">:</span>
            <span class="c1"># client is using as-yet-undefined extensions; abort</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">is_masked</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mask_payloadlen</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
        <span class="n">payloadlen</span> <span class="o">=</span> <span class="n">mask_payloadlen</span> <span class="o">&amp;</span> <span class="mh">0x7F</span>

        <span class="c1"># Parse and validate the length.</span>
        <span class="k">if</span> <span class="n">opcode_is_control</span> <span class="ow">and</span> <span class="n">payloadlen</span> <span class="o">&gt;=</span> <span class="mi">126</span><span class="p">:</span>
            <span class="c1"># control frames must have payload &lt; 126</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">payloadlen</span> <span class="o">&lt;</span> <span class="mi">126</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_length</span> <span class="o">=</span> <span class="n">payloadlen</span>
        <span class="k">elif</span> <span class="n">payloadlen</span> <span class="o">==</span> <span class="mi">126</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">payloadlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;!H&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">payloadlen</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">payloadlen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;!Q&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="n">payloadlen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_len</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">max_message_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">1009</span><span class="p">,</span> <span class="s2">&quot;message too big&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Read the payload, unmasking if necessary.</span>
        <span class="k">if</span> <span class="n">is_masked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_mask</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bytes</span><span class="p">(</span><span class="n">payloadlen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_masked</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">_websocket_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_mask</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># Decide what to do with this frame.</span>
        <span class="k">if</span> <span class="n">opcode_is_control</span><span class="p">:</span>
            <span class="c1"># control frames may be interleaved with a series of fragmented</span>
            <span class="c1"># data frames, so control frames must not interact with</span>
            <span class="c1"># self._fragmented_*</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_final_frame</span><span class="p">:</span>
                <span class="c1"># control frames must not be fragmented</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># continuation frame</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># nothing to continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="n">is_final_frame</span><span class="p">:</span>
                <span class="n">opcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_opcode</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># start of new data message</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># can&#39;t start new message until the old one is finished</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_final_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_opcode</span> <span class="o">=</span> <span class="n">opcode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fragmented_message_buffer</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">is_final_frame</span><span class="p">:</span>
            <span class="n">handled_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_message</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handled_future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">handled_future</span>

    <span class="k">def</span> <span class="nf">_handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Optional[Future[None]]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute on_message, returning its Future if it is a coroutine.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_compressed</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompressor</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">_DecompressTooLargeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">1009</span><span class="p">,</span> <span class="s2">&quot;message too big after decompression&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">:</span>
            <span class="c1"># UTF-8 data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_bytes_in</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">decoded</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_message</span><span class="p">,</span> <span class="n">decoded</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">:</span>
            <span class="c1"># Binary data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_bytes_in</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_message</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x8</span><span class="p">:</span>
            <span class="c1"># Close</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="n">to_unicode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="c1"># Echo the received close code, if any (RFC 6455 section 5.5.1).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x9</span><span class="p">:</span>
            <span class="c1"># Ping</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">StreamClosedError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_ping</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0xA</span><span class="p">:</span>
            <span class="c1"># Pong</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_pong</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_pong</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Closes the WebSocket connection.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_terminated</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">closed</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># &quot;normal closure&quot; status code</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">close_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">close_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">close_data</span> <span class="o">+=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_frame</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">close_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">StreamClosedError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_terminated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Give the client a few seconds to complete a clean shutdown,</span>
            <span class="c1"># otherwise just close the connection.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_closing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return ``True`` if this connection is closing.</span>

<span class="sd">        The connection is considered closing if either side has</span>
<span class="sd">        initiated its closing handshake or if the stream has been</span>
<span class="sd">        shut down uncleanly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">closed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_terminated</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_terminated</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ping_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ping_interval</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">interval</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ping_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ping_timeout</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">timeout</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_pinging</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Start sending periodic pings to keep the connection alive&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_ping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pong</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">periodic_ping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">periodic_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send a ping to keep the websocket alive</span>

<span class="sd">        Called periodically if the websocket_ping_interval is set and non-zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closing</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ping_callback</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Check for timeout on pong. Make sure that we really have</span>
        <span class="c1"># sent a recent ping in case the machine with both server and</span>
        <span class="c1"># client has been suspended since the last ping.</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">since_last_pong</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pong</span>
        <span class="n">since_last_ping</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_ping</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">since_last_ping</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span>
            <span class="ow">and</span> <span class="n">since_last_pong</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_timeout</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_ping</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_ping</span> <span class="o">=</span> <span class="n">now</span>

    <span class="k">def</span> <span class="nf">set_nodelay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">set_nodelay</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<div class="viewcode-block" id="WebSocketClientConnection"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClientConnection">[docs]</a><span class="k">class</span> <span class="nc">WebSocketClientConnection</span><span class="p">(</span><span class="n">simple_httpclient</span><span class="o">.</span><span class="n">_HTTPConnection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;WebSocket client connection.</span>

<span class="sd">    This class should not be instantiated directly; use the</span>
<span class="sd">    `websocket_connect` function instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: WebSocketProtocol</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">,</span>
        <span class="n">on_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ping_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_message_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_default_max_message_size</span><span class="p">,</span>
        <span class="n">subprotocols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>  <span class="c1"># type: Future[WebSocketClientConnection]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># type: Queue[Union[None, str, bytes]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_message_callback</span> <span class="o">=</span> <span class="n">on_message_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[int]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">_WebSocketParams</span><span class="p">(</span>
            <span class="n">ping_interval</span><span class="o">=</span><span class="n">ping_interval</span><span class="p">,</span>
            <span class="n">ping_timeout</span><span class="o">=</span><span class="n">ping_timeout</span><span class="p">,</span>
            <span class="n">max_message_size</span><span class="o">=</span><span class="n">max_message_size</span><span class="p">,</span>
            <span class="n">compression_options</span><span class="o">=</span><span class="n">compression_options</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">scheme</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ws&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">:</span> <span class="s2">&quot;https&quot;</span><span class="p">}[</span><span class="n">scheme</span><span class="p">]</span>
        <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">scheme</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">rest</span>
        <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Upgrade&quot;</span><span class="p">:</span> <span class="s2">&quot;websocket&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;Upgrade&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sec-WebSocket-Key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;Sec-WebSocket-Version&quot;</span><span class="p">:</span> <span class="s2">&quot;13&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">subprotocols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Sec-WebSocket-Protocol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subprotocols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compression_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Always offer to let the server set our max_wbits (and even though</span>
            <span class="c1"># we don&#39;t offer it, we will accept a client_no_context_takeover</span>
            <span class="c1"># from the server).</span>
            <span class="c1"># TODO: set server parameters for deflate extension</span>
            <span class="c1"># if requested in self.compression_options.</span>
            <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                <span class="s2">&quot;Sec-WebSocket-Extensions&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;permessage-deflate; client_max_window_bits&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tcp_client</span> <span class="o">=</span> <span class="n">TCPClient</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketClientConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_http_response</span><span class="p">,</span>
            <span class="mi">104857600</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tcp_client</span><span class="p">,</span>
            <span class="mi">65536</span><span class="p">,</span>
            <span class="mi">104857600</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="WebSocketClientConnection.close"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClientConnection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Closes the websocket connection.</span>

<span class="sd">        ``code`` and ``reason`` are documented under</span>
<span class="sd">        `WebSocketHandler.close`.</span>

<span class="sd">        .. versionadded:: 3.2</span>

<span class="sd">        .. versionchanged:: 4.0</span>

<span class="sd">           Added the ``code`` and ``reason`` arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span></div>

    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">StreamClosedError</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcp_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketClientConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_ws_connection_close</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">close_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">close_reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_code</span> <span class="o">=</span> <span class="n">close_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_reason</span> <span class="o">=</span> <span class="n">close_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_http_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span>
                    <span class="n">WebSocketError</span><span class="p">(</span><span class="s2">&quot;Non-websocket response&quot;</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">headers_received</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_line</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">httputil</span><span class="o">.</span><span class="n">RequestStartLine</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">ResponseStartLine</span><span class="p">],</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_line</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">ResponseStartLine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_line</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">101</span><span class="p">:</span>
            <span class="k">await</span> <span class="nb">super</span><span class="p">(</span><span class="n">WebSocketClientConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">headers_received</span><span class="p">(</span>
                <span class="n">start_line</span><span class="p">,</span> <span class="n">headers</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_websocket_protocol</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">_process_server_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">_receive_frame_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">start_pinging</span><span class="p">()</span>

        <span class="c1"># Once we&#39;ve taken over the connection, clear the final callback</span>
        <span class="c1"># we set on the http request.  This deactivates the error handling</span>
        <span class="c1"># in simple_httpclient that would otherwise interfere with our</span>
        <span class="c1"># ability to see exceptions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_callback</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="n">future_set_result_unless_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_future</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="WebSocketClientConnection.write_message"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClientConnection.write_message">[docs]</a>    <span class="k">def</span> <span class="nf">write_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">binary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Future[None]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends a message to the WebSocket server.</span>

<span class="sd">        If the stream is closed, raises `WebSocketClosedError`.</span>
<span class="sd">        Returns a `.Future` which can be used for flow control.</span>

<span class="sd">        .. versionchanged:: 5.0</span>
<span class="sd">           Exception raised on a closed stream changed from `.StreamClosedError`</span>
<span class="sd">           to `WebSocketClosedError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">)</span></div>

<div class="viewcode-block" id="WebSocketClientConnection.read_message"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClientConnection.read_message">[docs]</a>    <span class="k">def</span> <span class="nf">read_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Future[Union[None, str, bytes]]&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Reads a message from the WebSocket server.</span>

<span class="sd">        If on_message_callback was specified at WebSocket</span>
<span class="sd">        initialization, this function will never return messages</span>

<span class="sd">        Returns a future whose result is the message, or None</span>
<span class="sd">        if the connection is closed.  If a callback argument</span>
<span class="sd">        is given it will be called with the future when it is</span>
<span class="sd">        ready.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">awaitable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">awaitable</span><span class="p">),</span> <span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">awaitable</span></div>

    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_message_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_message_callback</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="WebSocketClientConnection.ping"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.WebSocketClientConnection.ping">[docs]</a>    <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send ping frame to the remote end.</span>

<span class="sd">        The data argument allows a small amount of data (up to 125</span>
<span class="sd">        bytes) to be sent as a part of the ping message. Note that not</span>
<span class="sd">        all websocket implementations expose this data to</span>
<span class="sd">        applications.</span>

<span class="sd">        Consider using the ``ping_interval`` argument to</span>
<span class="sd">        `websocket_connect` instead of sending pings manually.</span>

<span class="sd">        .. versionadded:: 5.1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WebSocketClosedError</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">write_ping</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">on_pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_ping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_websocket_protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSocketProtocol</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">WebSocketProtocol13</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_outgoing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_subprotocol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The subprotocol selected by the server.</span>

<span class="sd">        .. versionadded:: 5.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">selected_subprotocol</span>

    <span class="k">def</span> <span class="nf">log_exception</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">typ</span><span class="p">:</span> <span class="s2">&quot;Optional[Type[BaseException]]&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">app_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Uncaught exception </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span></div>


<div class="viewcode-block" id="websocket_connect"><a class="viewcode-back" href="../../websocket.html#tornado.websocket.websocket_connect">[docs]</a><span class="k">def</span> <span class="nf">websocket_connect</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">],</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Future[WebSocketClientConnection]&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">connect_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">on_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compression_options</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ping_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_message_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_default_max_message_size</span><span class="p">,</span>
    <span class="n">subprotocols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Awaitable[WebSocketClientConnection]&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Client-side websocket support.</span>

<span class="sd">    Takes a url and returns a Future whose result is a</span>
<span class="sd">    `WebSocketClientConnection`.</span>

<span class="sd">    ``compression_options`` is interpreted in the same way as the</span>
<span class="sd">    return value of `.WebSocketHandler.get_compression_options`.</span>

<span class="sd">    The connection supports two styles of operation. In the coroutine</span>
<span class="sd">    style, the application typically calls</span>
<span class="sd">    `~.WebSocketClientConnection.read_message` in a loop::</span>

<span class="sd">        conn = yield websocket_connect(url)</span>
<span class="sd">        while True:</span>
<span class="sd">            msg = yield conn.read_message()</span>
<span class="sd">            if msg is None: break</span>
<span class="sd">            # Do something with msg</span>

<span class="sd">    In the callback style, pass an ``on_message_callback`` to</span>
<span class="sd">    ``websocket_connect``. In both styles, a message of ``None``</span>
<span class="sd">    indicates that the connection has been closed.</span>

<span class="sd">    ``subprotocols`` may be a list of strings specifying proposed</span>
<span class="sd">    subprotocols. The selected protocol may be found on the</span>
<span class="sd">    ``selected_subprotocol`` attribute of the connection object</span>
<span class="sd">    when the connection is complete.</span>

<span class="sd">    .. versionchanged:: 3.2</span>
<span class="sd">       Also accepts ``HTTPRequest`` objects in place of urls.</span>

<span class="sd">    .. versionchanged:: 4.1</span>
<span class="sd">       Added ``compression_options`` and ``on_message_callback``.</span>

<span class="sd">    .. versionchanged:: 4.5</span>
<span class="sd">       Added the ``ping_interval``, ``ping_timeout``, and ``max_message_size``</span>
<span class="sd">       arguments, which have the same meaning as in `WebSocketHandler`.</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       The ``io_loop`` argument (deprecated since version 4.1) has been removed.</span>

<span class="sd">    .. versionchanged:: 5.1</span>
<span class="sd">       Added the ``subprotocols`` argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">connect_timeout</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1"># Copy and convert the headers dict/object (see comments in</span>
        <span class="c1"># AsyncHTTPClient.fetch)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">connect_timeout</span><span class="o">=</span><span class="n">connect_timeout</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
        <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">,</span>
        <span class="n">httpclient</span><span class="o">.</span><span class="n">_RequestProxy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="o">.</span><span class="n">_DEFAULTS</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">WebSocketClientConnection</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="n">on_message_callback</span><span class="o">=</span><span class="n">on_message_callback</span><span class="p">,</span>
        <span class="n">compression_options</span><span class="o">=</span><span class="n">compression_options</span><span class="p">,</span>
        <span class="n">ping_interval</span><span class="o">=</span><span class="n">ping_interval</span><span class="p">,</span>
        <span class="n">ping_timeout</span><span class="o">=</span><span class="n">ping_timeout</span><span class="p">,</span>
        <span class="n">max_message_size</span><span class="o">=</span><span class="n">max_message_size</span><span class="p">,</span>
        <span class="n">subprotocols</span><span class="o">=</span><span class="n">subprotocols</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">add_future</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">connect_future</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">connect_future</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The Tornado Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>