

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tornado.auth &mdash; Tornado 6.1.dev1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Tornado
          

          
          </a>

          
            
            
              <div class="version">
                6.1.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Userâ€™s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webframework.html">Web framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../http.html">HTTP servers and clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking.html">Asynchronous networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../coroutine.html">Coroutines and concurrency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integration with other services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Tornado</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>tornado.auth</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tornado.auth</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2009 Facebook</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1"># not use this file except in compliance with the License. You may obtain</span>
<span class="c1"># a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1"># License for the specific language governing permissions and limitations</span>
<span class="c1"># under the License.</span>

<span class="sd">&quot;&quot;&quot;This module contains implementations of various third-party</span>
<span class="sd">authentication schemes.</span>

<span class="sd">All the classes in this file are class mixins designed to be used with</span>
<span class="sd">the `tornado.web.RequestHandler` class.  They are used in two ways:</span>

<span class="sd">* On a login handler, use methods such as ``authenticate_redirect()``,</span>
<span class="sd">  ``authorize_redirect()``, and ``get_authenticated_user()`` to</span>
<span class="sd">  establish the user&#39;s identity and store authentication tokens to your</span>
<span class="sd">  database and/or cookies.</span>
<span class="sd">* In non-login handlers, use methods such as ``facebook_request()``</span>
<span class="sd">  or ``twitter_request()`` to use the authentication tokens to make</span>
<span class="sd">  requests to the respective services.</span>

<span class="sd">They all take slightly different arguments due to the fact all these</span>
<span class="sd">services implement authentication and authorization slightly differently.</span>
<span class="sd">See the individual service classes below for complete documentation.</span>

<span class="sd">Example usage for Google OAuth:</span>

<span class="sd">.. testcode::</span>

<span class="sd">    class GoogleOAuth2LoginHandler(tornado.web.RequestHandler,</span>
<span class="sd">                                   tornado.auth.GoogleOAuth2Mixin):</span>
<span class="sd">        async def get(self):</span>
<span class="sd">            if self.get_argument(&#39;code&#39;, False):</span>
<span class="sd">                user = await self.get_authenticated_user(</span>
<span class="sd">                    redirect_uri=&#39;http://your.site.com/auth/google&#39;,</span>
<span class="sd">                    code=self.get_argument(&#39;code&#39;))</span>
<span class="sd">                # Save the user with e.g. set_secure_cookie</span>
<span class="sd">            else:</span>
<span class="sd">                await self.authorize_redirect(</span>
<span class="sd">                    redirect_uri=&#39;http://your.site.com/auth/google&#39;,</span>
<span class="sd">                    client_id=self.settings[&#39;google_oauth&#39;][&#39;key&#39;],</span>
<span class="sd">                    scope=[&#39;profile&#39;, &#39;email&#39;],</span>
<span class="sd">                    response_type=&#39;code&#39;,</span>
<span class="sd">                    extra_params={&#39;approval_prompt&#39;: &#39;auto&#39;})</span>

<span class="sd">.. testoutput::</span>
<span class="sd">   :hide:</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">httpclient</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="k">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">tornado.httputil</span> <span class="k">import</span> <span class="n">url_concat</span>
<span class="kn">from</span> <span class="nn">tornado.util</span> <span class="k">import</span> <span class="n">unicode_type</span>
<span class="kn">from</span> <span class="nn">tornado.web</span> <span class="k">import</span> <span class="n">RequestHandler</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>


<span class="k">class</span> <span class="nc">AuthError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="OpenIdMixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.OpenIdMixin">[docs]</a><span class="k">class</span> <span class="nc">OpenIdMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract implementation of OpenID and Attribute Exchange.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    * ``_OPENID_ENDPOINT``: the identity provider&#39;s URI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OpenIdMixin.authenticate_redirect"><a class="viewcode-back" href="../../auth.html#tornado.auth.OpenIdMixin.authenticate_redirect">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate_redirect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ax_attrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Redirects to the authentication URL for this service.</span>

<span class="sd">        After authentication, the service will redirect back to the given</span>
<span class="sd">        callback URI with additional parameters including ``openid.mode``.</span>

<span class="sd">        We request the given attributes for the authenticated user by</span>
<span class="sd">        default (name, email, language, and username). If you don&#39;t need</span>
<span class="sd">        all those attributes for your app, you can request fewer with</span>
<span class="sd">        the ax_attrs keyword argument.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">            The ``callback`` argument was removed and this method no</span>
<span class="sd">            longer returns an awaitable object. It is now an ordinary</span>
<span class="sd">            synchronous function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">callback_uri</span> <span class="o">=</span> <span class="n">callback_uri</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span>
        <span class="k">assert</span> <span class="n">callback_uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openid_args</span><span class="p">(</span><span class="n">callback_uri</span><span class="p">,</span> <span class="n">ax_attrs</span><span class="o">=</span><span class="n">ax_attrs</span><span class="p">)</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OPENID_ENDPOINT</span>  <span class="c1"># type: ignore</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">endpoint</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenIdMixin.get_authenticated_user"><a class="viewcode-back" href="../../auth.html#tornado.auth.OpenIdMixin.get_authenticated_user">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">http_client</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fetches the authenticated user data upon redirect.</span>

<span class="sd">        This method should be called by the handler that receives the</span>
<span class="sd">        redirect from the `authenticate_redirect()` method (which is</span>
<span class="sd">        often the same as the one that calls it; in that case you would</span>
<span class="sd">        call `get_authenticated_user` if the ``openid.mode`` parameter</span>
<span class="sd">        is present and `authenticate_redirect` if it is not).</span>

<span class="sd">        The result of this method will generally be used to set a cookie.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">            The ``callback`` argument was removed. Use the returned</span>
<span class="sd">            awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Verify the OpenID response via direct request to the OP</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># type: Dict[str, Union[str, bytes]]</span>
        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;openid.mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;check_authentication&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OPENID_ENDPOINT</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">http_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_authentication_verified</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_openid_args</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ax_attrs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">oauth_scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">(),</span> <span class="n">callback_uri</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;openid.ns&quot;</span><span class="p">:</span> <span class="s2">&quot;http://specs.openid.net/auth/2.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;openid.claimed_id&quot;</span><span class="p">:</span> <span class="s2">&quot;http://specs.openid.net/auth/2.0/identifier_select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;openid.identity&quot;</span><span class="p">:</span> <span class="s2">&quot;http://specs.openid.net/auth/2.0/identifier_select&quot;</span><span class="p">,</span>
            <span class="s2">&quot;openid.return_to&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;openid.realm&quot;</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">),</span>
            <span class="s2">&quot;openid.mode&quot;</span><span class="p">:</span> <span class="s2">&quot;checkid_setup&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">ax_attrs</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;openid.ns.ax&quot;</span><span class="p">:</span> <span class="s2">&quot;http://openid.net/srv/ax/1.0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;openid.ax.mode&quot;</span><span class="p">:</span> <span class="s2">&quot;fetch_request&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">ax_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ax_attrs</span><span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">ax_attrs</span><span class="p">:</span>
                <span class="n">ax_attrs</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">])</span>
                <span class="n">required</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">]</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;openid.ax.type.firstname&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/namePerson/first&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;openid.ax.type.fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/namePerson&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;openid.ax.type.lastname&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/namePerson/last&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">known_attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/contact/email&quot;</span><span class="p">,</span>
                <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/pref/language&quot;</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;http://axschema.org/namePerson/friendly&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ax_attrs</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;openid.ax.type.&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">known_attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;openid.ax.required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oauth_scope</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;openid.ns.oauth&quot;</span><span class="p">:</span> <span class="s2">&quot;http://specs.openid.net/extensions/oauth/1.0&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;openid.oauth.consumer&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;openid.oauth.scope&quot;</span><span class="p">:</span> <span class="n">oauth_scope</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_on_authentication_verified</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPResponse</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;is_valid:true&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthError</span><span class="p">(</span><span class="s2">&quot;Invalid OpenID response: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="c1"># Make sure we got back at least an email from attribute exchange</span>
        <span class="n">ax_ns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;openid.ns.&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="sa">u</span><span class="s2">&quot;http://openid.net/srv/ax/1.0&quot;</span>
            <span class="p">):</span>
                <span class="n">ax_ns</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="k">break</span>

        <span class="k">def</span> <span class="nf">get_ax_arg</span><span class="p">(</span><span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ax_ns</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;openid.&quot;</span> <span class="o">+</span> <span class="n">ax_ns</span> <span class="o">+</span> <span class="s2">&quot;.type.&quot;</span>
            <span class="n">ax_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">uri</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span>
                    <span class="n">ax_name</span> <span class="o">=</span> <span class="s2">&quot;openid.&quot;</span> <span class="o">+</span> <span class="n">ax_ns</span> <span class="o">+</span> <span class="s2">&quot;.value.&quot;</span> <span class="o">+</span> <span class="n">part</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ax_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="n">ax_name</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">email</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/contact/email&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/namePerson&quot;</span><span class="p">)</span>
        <span class="n">first_name</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/namePerson/first&quot;</span><span class="p">)</span>
        <span class="n">last_name</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/namePerson/last&quot;</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/namePerson/friendly&quot;</span><span class="p">)</span>
        <span class="n">locale</span> <span class="o">=</span> <span class="n">get_ax_arg</span><span class="p">(</span><span class="s2">&quot;http://axschema.org/pref/language&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">name_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">first_name</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_name</span>
            <span class="n">name_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_name</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;last_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_name</span>
            <span class="n">name_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">elif</span> <span class="n">name_parts</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">email</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
        <span class="k">if</span> <span class="n">locale</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;locale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale</span>
        <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">claimed_id</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;openid.claimed_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">claimed_id</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;claimed_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">claimed_id</span>
        <span class="k">return</span> <span class="n">user</span>

<div class="viewcode-block" id="OpenIdMixin.get_auth_http_client"><a class="viewcode-back" href="../../auth.html#tornado.auth.OpenIdMixin.get_auth_http_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_auth_http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the `.AsyncHTTPClient` instance to be used for auth requests.</span>

<span class="sd">        May be overridden by subclasses to use an HTTP client other than</span>
<span class="sd">        the default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="OAuthMixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin">[docs]</a><span class="k">class</span> <span class="nc">OAuthMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract implementation of OAuth 1.0 and 1.0a.</span>

<span class="sd">    See `TwitterMixin` below for an example implementation.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    * ``_OAUTH_AUTHORIZE_URL``: The service&#39;s OAuth authorization url.</span>
<span class="sd">    * ``_OAUTH_ACCESS_TOKEN_URL``: The service&#39;s OAuth access token url.</span>
<span class="sd">    * ``_OAUTH_VERSION``: May be either &quot;1.0&quot; or &quot;1.0a&quot;.</span>
<span class="sd">    * ``_OAUTH_NO_CALLBACKS``: Set this to True if the service requires</span>
<span class="sd">      advance registration of callbacks.</span>

<span class="sd">    Subclasses must also override the `_oauth_get_user_future` and</span>
<span class="sd">    `_oauth_consumer_token` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OAuthMixin.authorize_redirect"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin.authorize_redirect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">authorize_redirect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">http_client</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Redirects the user to obtain OAuth authorization for this service.</span>

<span class="sd">        The ``callback_uri`` may be omitted if you have previously</span>
<span class="sd">        registered a callback URI with the third-party service. For</span>
<span class="sd">        some services, you must use a previously-registered callback</span>
<span class="sd">        URI and cannot specify a callback via this method.</span>

<span class="sd">        This method sets a cookie called ``_oauth_request_token`` which is</span>
<span class="sd">        subsequently used (and cleared) in `get_authenticated_user` for</span>
<span class="sd">        security purposes.</span>

<span class="sd">        This method is asynchronous and must be called with ``await``</span>
<span class="sd">        or ``yield`` (This is different from other ``auth*_redirect``</span>
<span class="sd">        methods defined in this module). It calls</span>
<span class="sd">        `.RequestHandler.finish` for you so you should not write any</span>
<span class="sd">        other response after it returns.</span>

<span class="sd">        .. versionchanged:: 3.1</span>
<span class="sd">           Now returns a `.Future` and takes an optional callback, for</span>
<span class="sd">           compatibility with `.gen.coroutine`.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned</span>
<span class="sd">           awaitable object instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback_uri</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_OAUTH_NO_CALLBACKS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This service does not support oauth_callback&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">http_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_OAUTH_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">(</span>
                    <span class="n">callback_uri</span><span class="o">=</span><span class="n">callback_uri</span><span class="p">,</span> <span class="n">extra_params</span><span class="o">=</span><span class="n">extra_params</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">())</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_AUTHORIZE_URL</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_request_token</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback_uri</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAuthMixin.get_authenticated_user"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin.get_authenticated_user">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">http_client</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Gets the OAuth authorized user and access token.</span>

<span class="sd">        This method should be called from the handler for your</span>
<span class="sd">        OAuth callback URL to complete the registration process. We run the</span>
<span class="sd">        callback with the authenticated user dictionary.  This dictionary</span>
<span class="sd">        will contain an ``access_key`` which can be used to make authorized</span>
<span class="sd">        requests to this service on behalf of the user.  The dictionary will</span>
<span class="sd">        also contain other fields such as ``name``, depending on the service</span>
<span class="sd">        used.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned</span>
<span class="sd">           awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">request_key</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;oauth_token&quot;</span><span class="p">))</span>
        <span class="n">oauth_verifier</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;oauth_verifier&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">request_cookie</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="s2">&quot;_oauth_request_token&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_cookie</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthError</span><span class="p">(</span><span class="s2">&quot;Missing OAuth request token cookie&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="s2">&quot;_oauth_request_token&quot;</span><span class="p">)</span>
        <span class="n">cookie_key</span><span class="p">,</span> <span class="n">cookie_secret</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request_cookie</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">cookie_key</span> <span class="o">!=</span> <span class="n">request_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthError</span><span class="p">(</span><span class="s2">&quot;Request token does not match cookie&quot;</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">cookie_key</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">cookie_secret</span>
        <span class="p">)</span>  <span class="c1"># type: Dict[str, Union[str, bytes]]</span>
        <span class="k">if</span> <span class="n">oauth_verifier</span><span class="p">:</span>
            <span class="n">token</span><span class="p">[</span><span class="s2">&quot;verifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oauth_verifier</span>
        <span class="k">if</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">http_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">http_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_oauth_access_token_url</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">_oauth_parse_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_get_user_future</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthError</span><span class="p">(</span><span class="s2">&quot;Error getting user&quot;</span><span class="p">)</span>
        <span class="n">user</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
        <span class="k">return</span> <span class="n">user</span></div>

    <span class="k">def</span> <span class="nf">_oauth_request_token_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">callback_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extra_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">consumer_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_consumer_token</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_REQUEST_TOKEN_URL</span>  <span class="c1"># type: ignore</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">oauth_consumer_key</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]),</span>
            <span class="n">oauth_signature_method</span><span class="o">=</span><span class="s2">&quot;HMAC-SHA1&quot;</span><span class="p">,</span>
            <span class="n">oauth_timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
            <span class="n">oauth_nonce</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">bytes</span><span class="p">)),</span>
            <span class="n">oauth_version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_OAUTH_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callback_uri</span> <span class="o">==</span> <span class="s2">&quot;oob&quot;</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;oob&quot;</span>
            <span class="k">elif</span> <span class="n">callback_uri</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">(),</span> <span class="n">callback_uri</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_params</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_params</span><span class="p">)</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth10a_signature</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth_signature</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_signature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signature</span>
        <span class="k">return</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_request_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">authorize_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">callback_uri</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">request_token</span> <span class="o">=</span> <span class="n">_oauth_parse_response</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">request_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]))</span>
            <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;|&quot;</span>
            <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">request_token</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">&quot;_oauth_request_token&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">oauth_token</span><span class="o">=</span><span class="n">request_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">callback_uri</span> <span class="o">==</span> <span class="s2">&quot;oob&quot;</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">authorize_url</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">callback_uri</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">(),</span> <span class="n">callback_uri</span>
            <span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">authorize_url</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_oauth_access_token_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">consumer_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_consumer_token</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_ACCESS_TOKEN_URL</span>  <span class="c1"># type: ignore</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">oauth_consumer_key</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]),</span>
            <span class="n">oauth_token</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">request_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]),</span>
            <span class="n">oauth_signature_method</span><span class="o">=</span><span class="s2">&quot;HMAC-SHA1&quot;</span><span class="p">,</span>
            <span class="n">oauth_timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
            <span class="n">oauth_nonce</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">bytes</span><span class="p">)),</span>
            <span class="n">oauth_version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;verifier&quot;</span> <span class="ow">in</span> <span class="n">request_token</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_verifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_token</span><span class="p">[</span><span class="s2">&quot;verifier&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_OAUTH_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth10a_signature</span><span class="p">(</span>
                <span class="n">consumer_token</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">request_token</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth_signature</span><span class="p">(</span>
                <span class="n">consumer_token</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">request_token</span>
            <span class="p">)</span>

        <span class="n">args</span><span class="p">[</span><span class="s2">&quot;oauth_signature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signature</span>
        <span class="k">return</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="OAuthMixin._oauth_consumer_token"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin._oauth_consumer_token">[docs]</a>    <span class="k">def</span> <span class="nf">_oauth_consumer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Subclasses must override this to return their OAuth consumer keys.</span>

<span class="sd">        The return value should be a `dict` with keys ``key`` and ``secret``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="OAuthMixin._oauth_get_user_future"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin._oauth_get_user_future">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_oauth_get_user_future</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Subclasses must override this to get basic information about the</span>
<span class="sd">        user.</span>

<span class="sd">        Should be a coroutine whose result is a dictionary</span>
<span class="sd">        containing information about the user, which may have been</span>
<span class="sd">        retrieved by using ``access_token`` to make a request to the</span>
<span class="sd">        service.</span>

<span class="sd">        The access token will be added to the returned dictionary to make</span>
<span class="sd">        the result of `get_authenticated_user`.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           Subclasses may also define this method with ``async def``.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           A synchronous fallback to ``_oauth_get_user`` was removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_oauth_request_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns the OAuth parameters as a dict for the given request.</span>

<span class="sd">        parameters should include all POST arguments and query string arguments</span>
<span class="sd">        that will be sent with the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">consumer_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_consumer_token</span><span class="p">()</span>
        <span class="n">base_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">oauth_consumer_key</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]),</span>
            <span class="n">oauth_token</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">access_token</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]),</span>
            <span class="n">oauth_signature_method</span><span class="o">=</span><span class="s2">&quot;HMAC-SHA1&quot;</span><span class="p">,</span>
            <span class="n">oauth_timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span>
            <span class="n">oauth_nonce</span><span class="o">=</span><span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">bytes</span><span class="p">)),</span>
            <span class="n">oauth_version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base_args</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_OAUTH_VERSION&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1.0a&quot;</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth10a_signature</span><span class="p">(</span>
                <span class="n">consumer_token</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">access_token</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">_oauth_signature</span><span class="p">(</span>
                <span class="n">consumer_token</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">access_token</span>
            <span class="p">)</span>
        <span class="n">base_args</span><span class="p">[</span><span class="s2">&quot;oauth_signature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">to_basestring</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_args</span>

<div class="viewcode-block" id="OAuthMixin.get_auth_http_client"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuthMixin.get_auth_http_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_auth_http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the `.AsyncHTTPClient` instance to be used for auth requests.</span>

<span class="sd">        May be overridden by subclasses to use an HTTP client other than</span>
<span class="sd">        the default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="OAuth2Mixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuth2Mixin">[docs]</a><span class="k">class</span> <span class="nc">OAuth2Mixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract implementation of OAuth 2.0.</span>

<span class="sd">    See `FacebookGraphMixin` or `GoogleOAuth2Mixin` below for example</span>
<span class="sd">    implementations.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    * ``_OAUTH_AUTHORIZE_URL``: The service&#39;s authorization url.</span>
<span class="sd">    * ``_OAUTH_ACCESS_TOKEN_URL``:  The service&#39;s access token url.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OAuth2Mixin.authorize_redirect"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuth2Mixin.authorize_redirect">[docs]</a>    <span class="k">def</span> <span class="nf">authorize_redirect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Redirects the user to obtain OAuth authorization for this service.</span>

<span class="sd">        Some providers require that you register a redirect URL with</span>
<span class="sd">        your application instead of passing one via this method. You</span>
<span class="sd">        should call this method to log the user in, and then call</span>
<span class="sd">        ``get_authenticated_user`` in the handler for your</span>
<span class="sd">        redirect URL to complete the authorization process.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument and returned awaitable were removed;</span>
<span class="sd">           this is now an ordinary synchronous function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;response_type&quot;</span><span class="p">:</span> <span class="n">response_type</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">redirect_uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redirect_uri</span>
        <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="k">if</span> <span class="n">extra_params</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_AUTHORIZE_URL</span>  <span class="c1"># type: ignore</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url_concat</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_oauth_request_token_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_ACCESS_TOKEN_URL</span>  <span class="c1"># type: ignore</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
        <span class="k">if</span> <span class="n">redirect_uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;redirect_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">redirect_uri</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="k">if</span> <span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="k">if</span> <span class="n">client_secret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;client_secret&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_secret</span>
        <span class="k">if</span> <span class="n">extra_params</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url_concat</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="OAuth2Mixin.oauth2_request"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuth2Mixin.oauth2_request">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">oauth2_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">post_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetches the given URL auth an OAuth2 access token.</span>

<span class="sd">        If the request is a POST, ``post_args`` should be provided. Query</span>
<span class="sd">        string arguments should be given as keyword arguments.</span>

<span class="sd">        Example usage:</span>

<span class="sd">        ..testcode::</span>

<span class="sd">            class MainHandler(tornado.web.RequestHandler,</span>
<span class="sd">                              tornado.auth.FacebookGraphMixin):</span>
<span class="sd">                @tornado.web.authenticated</span>
<span class="sd">                async def get(self):</span>
<span class="sd">                    new_entry = await self.oauth2_request(</span>
<span class="sd">                        &quot;https://graph.facebook.com/me/feed&quot;,</span>
<span class="sd">                        post_args={&quot;message&quot;: &quot;I am posting from my Tornado application!&quot;},</span>
<span class="sd">                        access_token=self.current_user[&quot;access_token&quot;])</span>

<span class="sd">                    if not new_entry:</span>
<span class="sd">                        # Call failed; perhaps missing permission?</span>
<span class="sd">                        await self.authorize_redirect()</span>
<span class="sd">                        return</span>
<span class="sd">                    self.finish(&quot;Posted a message!&quot;)</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">           :hide:</span>

<span class="sd">        .. versionadded:: 4.3</span>

<span class="sd">        .. versionchanged::: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">access_token</span><span class="p">:</span>
            <span class="n">all_args</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_token</span>
            <span class="n">all_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_args</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">all_args</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">post_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">post_args</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>

<div class="viewcode-block" id="OAuth2Mixin.get_auth_http_client"><a class="viewcode-back" href="../../auth.html#tornado.auth.OAuth2Mixin.get_auth_http_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_auth_http_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the `.AsyncHTTPClient` instance to be used for auth requests.</span>

<span class="sd">        May be overridden by subclasses to use an HTTP client other than</span>
<span class="sd">        the default.</span>

<span class="sd">        .. versionadded:: 4.3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TwitterMixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.TwitterMixin">[docs]</a><span class="k">class</span> <span class="nc">TwitterMixin</span><span class="p">(</span><span class="n">OAuthMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Twitter OAuth authentication.</span>

<span class="sd">    To authenticate with Twitter, register your application with</span>
<span class="sd">    Twitter at http://twitter.com/apps. Then copy your Consumer Key</span>
<span class="sd">    and Consumer Secret to the application</span>
<span class="sd">    `~tornado.web.Application.settings` ``twitter_consumer_key`` and</span>
<span class="sd">    ``twitter_consumer_secret``. Use this mixin on the handler for the</span>
<span class="sd">    URL you registered as your application&#39;s callback URL.</span>

<span class="sd">    When your application is set up, you can use this mixin like this</span>
<span class="sd">    to authenticate the user with Twitter and get access to their stream:</span>

<span class="sd">    .. testcode::</span>

<span class="sd">        class TwitterLoginHandler(tornado.web.RequestHandler,</span>
<span class="sd">                                  tornado.auth.TwitterMixin):</span>
<span class="sd">            async def get(self):</span>
<span class="sd">                if self.get_argument(&quot;oauth_token&quot;, None):</span>
<span class="sd">                    user = await self.get_authenticated_user()</span>
<span class="sd">                    # Save the user using e.g. set_secure_cookie()</span>
<span class="sd">                else:</span>
<span class="sd">                    await self.authorize_redirect()</span>

<span class="sd">    .. testoutput::</span>
<span class="sd">       :hide:</span>

<span class="sd">    The user object returned by `~OAuthMixin.get_authenticated_user`</span>
<span class="sd">    includes the attributes ``username``, ``name``, ``access_token``,</span>
<span class="sd">    and all of the custom Twitter user attributes described at</span>
<span class="sd">    https://dev.twitter.com/docs/api/1.1/get/users/show</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_OAUTH_REQUEST_TOKEN_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.twitter.com/oauth/request_token&quot;</span>
    <span class="n">_OAUTH_ACCESS_TOKEN_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.twitter.com/oauth/access_token&quot;</span>
    <span class="n">_OAUTH_AUTHORIZE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.twitter.com/oauth/authorize&quot;</span>
    <span class="n">_OAUTH_AUTHENTICATE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.twitter.com/oauth/authenticate&quot;</span>
    <span class="n">_OAUTH_NO_CALLBACKS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_TWITTER_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://api.twitter.com/1.1&quot;</span>

<div class="viewcode-block" id="TwitterMixin.authenticate_redirect"><a class="viewcode-back" href="../../auth.html#tornado.auth.TwitterMixin.authenticate_redirect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">authenticate_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just like `~OAuthMixin.authorize_redirect`, but</span>
<span class="sd">        auto-redirects if authorized.</span>

<span class="sd">        This is generally the right interface to use if you are using</span>
<span class="sd">        Twitter for single-sign on.</span>

<span class="sd">        .. versionchanged:: 3.1</span>
<span class="sd">           Now returns a `.Future` and takes an optional callback, for</span>
<span class="sd">           compatibility with `.gen.coroutine`.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned</span>
<span class="sd">           awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">(</span><span class="n">callback_uri</span><span class="o">=</span><span class="n">callback_uri</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_request_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_AUTHENTICATE_URL</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="TwitterMixin.twitter_request"><a class="viewcode-back" href="../../auth.html#tornado.auth.TwitterMixin.twitter_request">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">twitter_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">post_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetches the given API path, e.g., ``statuses/user_timeline/btaylor``</span>

<span class="sd">        The path should not include the format or API version number.</span>
<span class="sd">        (we automatically use JSON format and API version 1).</span>

<span class="sd">        If the request is a POST, ``post_args`` should be provided. Query</span>
<span class="sd">        string arguments should be given as keyword arguments.</span>

<span class="sd">        All the Twitter methods are documented at http://dev.twitter.com/</span>

<span class="sd">        Many methods require an OAuth access token which you can</span>
<span class="sd">        obtain through `~OAuthMixin.authorize_redirect` and</span>
<span class="sd">        `~OAuthMixin.get_authenticated_user`. The user returned through that</span>
<span class="sd">        process includes an &#39;access_token&#39; attribute that can be used</span>
<span class="sd">        to make authenticated requests via this method. Example</span>
<span class="sd">        usage:</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            class MainHandler(tornado.web.RequestHandler,</span>
<span class="sd">                              tornado.auth.TwitterMixin):</span>
<span class="sd">                @tornado.web.authenticated</span>
<span class="sd">                async def get(self):</span>
<span class="sd">                    new_entry = await self.twitter_request(</span>
<span class="sd">                        &quot;/statuses/update&quot;,</span>
<span class="sd">                        post_args={&quot;status&quot;: &quot;Testing Tornado Web Server&quot;},</span>
<span class="sd">                        access_token=self.current_user[&quot;access_token&quot;])</span>
<span class="sd">                    if not new_entry:</span>
<span class="sd">                        # Call failed; perhaps missing permission?</span>
<span class="sd">                        yield self.authorize_redirect()</span>
<span class="sd">                        return</span>
<span class="sd">                    self.finish(&quot;Posted a message!&quot;)</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">           :hide:</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned</span>
<span class="sd">           awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https:&quot;</span><span class="p">):</span>
            <span class="c1"># Raw urls are useful for e.g. search which doesn&#39;t follow the</span>
            <span class="c1"># usual pattern: http://search.twitter.com/search.json</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TWITTER_BASE_URL</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="c1"># Add the OAuth resource request signature if we have credentials</span>
        <span class="k">if</span> <span class="n">access_token</span><span class="p">:</span>
            <span class="n">all_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">all_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">all_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">post_args</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span> <span class="k">if</span> <span class="n">post_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;GET&quot;</span>
            <span class="n">oauth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_parameters</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">all_args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
            <span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">post_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">post_args</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_oauth_consumer_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">&quot;twitter_consumer_key&quot;</span><span class="p">,</span> <span class="s2">&quot;Twitter OAuth&quot;</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">&quot;twitter_consumer_secret&quot;</span><span class="p">,</span> <span class="s2">&quot;Twitter OAuth&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;twitter_consumer_key&quot;</span><span class="p">],</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;twitter_consumer_secret&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_oauth_get_user_future</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">twitter_request</span><span class="p">(</span>
            <span class="s2">&quot;/account/verify_credentials&quot;</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">user</span></div>


<div class="viewcode-block" id="GoogleOAuth2Mixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.GoogleOAuth2Mixin">[docs]</a><span class="k">class</span> <span class="nc">GoogleOAuth2Mixin</span><span class="p">(</span><span class="n">OAuth2Mixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Google authentication using OAuth2.</span>

<span class="sd">    In order to use, register your application with Google and copy the</span>
<span class="sd">    relevant parameters to your application settings.</span>

<span class="sd">    * Go to the Google Dev Console at http://console.developers.google.com</span>
<span class="sd">    * Select a project, or create a new one.</span>
<span class="sd">    * In the sidebar on the left, select APIs &amp; Auth.</span>
<span class="sd">    * In the list of APIs, find the Google+ API service and set it to ON.</span>
<span class="sd">    * In the sidebar on the left, select Credentials.</span>
<span class="sd">    * In the OAuth section of the page, select Create New Client ID.</span>
<span class="sd">    * Set the Redirect URI to point to your auth handler</span>
<span class="sd">    * Copy the &quot;Client secret&quot; and &quot;Client ID&quot; to the application settings as</span>
<span class="sd">      ``{&quot;google_oauth&quot;: {&quot;key&quot;: CLIENT_ID, &quot;secret&quot;: CLIENT_SECRET}}``</span>

<span class="sd">    .. versionadded:: 3.2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_OAUTH_AUTHORIZE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/v2/auth&quot;</span>
    <span class="n">_OAUTH_ACCESS_TOKEN_URL</span> <span class="o">=</span> <span class="s2">&quot;https://www.googleapis.com/oauth2/v4/token&quot;</span>
    <span class="n">_OAUTH_USERINFO_URL</span> <span class="o">=</span> <span class="s2">&quot;https://www.googleapis.com/oauth2/v1/userinfo&quot;</span>
    <span class="n">_OAUTH_NO_CALLBACKS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_OAUTH_SETTINGS_KEY</span> <span class="o">=</span> <span class="s2">&quot;google_oauth&quot;</span>

<div class="viewcode-block" id="GoogleOAuth2Mixin.get_authenticated_user"><a class="viewcode-back" href="../../auth.html#tornado.auth.GoogleOAuth2Mixin.get_authenticated_user">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Handles the login for the Google user, returning an access token.</span>

<span class="sd">        The result is a dictionary containing an ``access_token`` field</span>
<span class="sd">        ([among others](https://developers.google.com/identity/protocols/OAuth2WebServer#handlingtheresponse)).</span>
<span class="sd">        Unlike other ``get_authenticated_user`` methods in this package,</span>
<span class="sd">        this method does not return any additional information about the user.</span>
<span class="sd">        The returned access token can be used with `OAuth2Mixin.oauth2_request`</span>
<span class="sd">        to request additional information (perhaps from</span>
<span class="sd">        ``https://www.googleapis.com/oauth2/v2/userinfo``)</span>

<span class="sd">        Example usage:</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            class GoogleOAuth2LoginHandler(tornado.web.RequestHandler,</span>
<span class="sd">                                           tornado.auth.GoogleOAuth2Mixin):</span>
<span class="sd">                async def get(self):</span>
<span class="sd">                    if self.get_argument(&#39;code&#39;, False):</span>
<span class="sd">                        access = await self.get_authenticated_user(</span>
<span class="sd">                            redirect_uri=&#39;http://your.site.com/auth/google&#39;,</span>
<span class="sd">                            code=self.get_argument(&#39;code&#39;))</span>
<span class="sd">                        user = await self.oauth2_request(</span>
<span class="sd">                            &quot;https://www.googleapis.com/oauth2/v1/userinfo&quot;,</span>
<span class="sd">                            access_token=access[&quot;access_token&quot;])</span>
<span class="sd">                        # Save the user and access token with</span>
<span class="sd">                        # e.g. set_secure_cookie.</span>
<span class="sd">                    else:</span>
<span class="sd">                        await self.authorize_redirect(</span>
<span class="sd">                            redirect_uri=&#39;http://your.site.com/auth/google&#39;,</span>
<span class="sd">                            client_id=self.settings[&#39;google_oauth&#39;][&#39;key&#39;],</span>
<span class="sd">                            scope=[&#39;profile&#39;, &#39;email&#39;],</span>
<span class="sd">                            response_type=&#39;code&#39;,</span>
<span class="sd">                            extra_params={&#39;approval_prompt&#39;: &#39;auto&#39;})</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">           :hide:</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
                <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
                <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_SETTINGS_KEY</span><span class="p">][</span><span class="s2">&quot;key&quot;</span><span class="p">],</span>
                <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">handler</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_SETTINGS_KEY</span><span class="p">][</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span>
                <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;authorization_code&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OAUTH_ACCESS_TOKEN_URL</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FacebookGraphMixin"><a class="viewcode-back" href="../../auth.html#tornado.auth.FacebookGraphMixin">[docs]</a><span class="k">class</span> <span class="nc">FacebookGraphMixin</span><span class="p">(</span><span class="n">OAuth2Mixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Facebook authentication using the new Graph API and OAuth2.&quot;&quot;&quot;</span>

    <span class="n">_OAUTH_ACCESS_TOKEN_URL</span> <span class="o">=</span> <span class="s2">&quot;https://graph.facebook.com/oauth/access_token?&quot;</span>
    <span class="n">_OAUTH_AUTHORIZE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://www.facebook.com/dialog/oauth?&quot;</span>
    <span class="n">_OAUTH_NO_CALLBACKS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_FACEBOOK_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://graph.facebook.com&quot;</span>

<div class="viewcode-block" id="FacebookGraphMixin.get_authenticated_user"><a class="viewcode-back" href="../../auth.html#tornado.auth.FacebookGraphMixin.get_authenticated_user">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_authenticated_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">extra_fields</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Handles the login for the Facebook user, returning a user object.</span>

<span class="sd">        Example usage:</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            class FacebookGraphLoginHandler(tornado.web.RequestHandler,</span>
<span class="sd">                                            tornado.auth.FacebookGraphMixin):</span>
<span class="sd">              async def get(self):</span>
<span class="sd">                  if self.get_argument(&quot;code&quot;, False):</span>
<span class="sd">                      user = await self.get_authenticated_user(</span>
<span class="sd">                          redirect_uri=&#39;/auth/facebookgraph/&#39;,</span>
<span class="sd">                          client_id=self.settings[&quot;facebook_api_key&quot;],</span>
<span class="sd">                          client_secret=self.settings[&quot;facebook_secret&quot;],</span>
<span class="sd">                          code=self.get_argument(&quot;code&quot;))</span>
<span class="sd">                      # Save the user with e.g. set_secure_cookie</span>
<span class="sd">                  else:</span>
<span class="sd">                      await self.authorize_redirect(</span>
<span class="sd">                          redirect_uri=&#39;/auth/facebookgraph/&#39;,</span>
<span class="sd">                          client_id=self.settings[&quot;facebook_api_key&quot;],</span>
<span class="sd">                          extra_params={&quot;scope&quot;: &quot;read_stream,offline_access&quot;})</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">           :hide:</span>

<span class="sd">        This method returns a dictionary which may contain the following fields:</span>

<span class="sd">        * ``access_token``, a string which may be passed to `facebook_request`</span>
<span class="sd">        * ``session_expires``, an integer encoded as a string representing</span>
<span class="sd">          the time until the access token expires in seconds. This field should</span>
<span class="sd">          be used like ``int(user[&#39;session_expires&#39;])``; in a future version of</span>
<span class="sd">          Tornado it will change from a string to an integer.</span>
<span class="sd">        * ``id``, ``name``, ``first_name``, ``last_name``, ``locale``, ``picture``,</span>
<span class="sd">          ``link``, plus any fields named in the ``extra_fields`` argument. These</span>
<span class="sd">          fields are copied from the Facebook graph API</span>
<span class="sd">          `user object &lt;https://developers.facebook.com/docs/graph-api/reference/user&gt;`_</span>

<span class="sd">        .. versionchanged:: 4.5</span>
<span class="sd">           The ``session_expires`` field was updated to support changes made to the</span>
<span class="sd">           Facebook API in March 2017.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_auth_http_client</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
            <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">client_secret</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span><span class="p">,</span> <span class="s2">&quot;locale&quot;</span><span class="p">,</span> <span class="s2">&quot;picture&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_fields</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_oauth_request_token_url</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">),</span>
            <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_in&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">facebook_request</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/me&quot;</span><span class="p">,</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">],</span>
            <span class="n">appsecret_proof</span><span class="o">=</span><span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">client_secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
                <span class="n">msg</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">),</span>
                <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
            <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fieldmap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fieldmap</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># session_expires is converted to str for compatibility with</span>
        <span class="c1"># older versions in which the server used url-encoding and</span>
        <span class="c1"># this code simply returned the string verbatim.</span>
        <span class="c1"># This should change in Tornado 5.0.</span>
        <span class="n">fieldmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">],</span>
                <span class="s2">&quot;session_expires&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expires_in&quot;</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fieldmap</span></div>

<div class="viewcode-block" id="FacebookGraphMixin.facebook_request"><a class="viewcode-back" href="../../auth.html#tornado.auth.FacebookGraphMixin.facebook_request">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">facebook_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">post_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetches the given relative API path, e.g., &quot;/btaylor/picture&quot;</span>

<span class="sd">        If the request is a POST, ``post_args`` should be provided. Query</span>
<span class="sd">        string arguments should be given as keyword arguments.</span>

<span class="sd">        An introduction to the Facebook Graph API can be found at</span>
<span class="sd">        http://developers.facebook.com/docs/api</span>

<span class="sd">        Many methods require an OAuth access token which you can</span>
<span class="sd">        obtain through `~OAuth2Mixin.authorize_redirect` and</span>
<span class="sd">        `get_authenticated_user`. The user returned through that</span>
<span class="sd">        process includes an ``access_token`` attribute that can be</span>
<span class="sd">        used to make authenticated requests via this method.</span>

<span class="sd">        Example usage:</span>

<span class="sd">        .. testcode::</span>

<span class="sd">            class MainHandler(tornado.web.RequestHandler,</span>
<span class="sd">                              tornado.auth.FacebookGraphMixin):</span>
<span class="sd">                @tornado.web.authenticated</span>
<span class="sd">                async def get(self):</span>
<span class="sd">                    new_entry = await self.facebook_request(</span>
<span class="sd">                        &quot;/me/feed&quot;,</span>
<span class="sd">                        post_args={&quot;message&quot;: &quot;I am posting from my Tornado application!&quot;},</span>
<span class="sd">                        access_token=self.current_user[&quot;access_token&quot;])</span>

<span class="sd">                    if not new_entry:</span>
<span class="sd">                        # Call failed; perhaps missing permission?</span>
<span class="sd">                        yield self.authorize_redirect()</span>
<span class="sd">                        return</span>
<span class="sd">                    self.finish(&quot;Posted a message!&quot;)</span>

<span class="sd">        .. testoutput::</span>
<span class="sd">           :hide:</span>

<span class="sd">        The given path is relative to ``self._FACEBOOK_BASE_URL``,</span>
<span class="sd">        by default &quot;https://graph.facebook.com&quot;.</span>

<span class="sd">        This method is a wrapper around `OAuth2Mixin.oauth2_request`;</span>
<span class="sd">        the only difference is that this method takes a relative path,</span>
<span class="sd">        while ``oauth2_request`` takes a complete url.</span>

<span class="sd">        .. versionchanged:: 3.1</span>
<span class="sd">           Added the ability to override ``self._FACEBOOK_BASE_URL``.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed. Use the returned awaitable object instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FACEBOOK_BASE_URL</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth2_request</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span> <span class="n">post_args</span><span class="o">=</span><span class="n">post_args</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span>
        <span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_oauth_signature</span><span class="p">(</span>
    <span class="n">consumer_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculates the HMAC-SHA1 OAuth signature for the given request.</span>

<span class="sd">    See http://oauth.net/core/1.0/#signing_process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">normalized_url</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span> <span class="o">+</span> <span class="n">netloc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">path</span>

    <span class="n">base_elems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_url</span><span class="p">)</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_oauth_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">base_string</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_oauth_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">base_elems</span><span class="p">)</span>

    <span class="n">key_elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">])]</span>
    <span class="n">key_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_elems</span><span class="p">)</span>

    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">base_string</span><span class="p">),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="nb">hash</span><span class="o">.</span><span class="n">digest</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_oauth10a_signature</span><span class="p">(</span>
    <span class="n">consumer_token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculates the HMAC-SHA1 OAuth 1.0a signature for the given request.</span>

<span class="sd">    See http://oauth.net/core/1.0a/#signing_process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">normalized_url</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span> <span class="o">+</span> <span class="n">netloc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">path</span>

    <span class="n">base_elems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_url</span><span class="p">)</span>
    <span class="n">base_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_oauth_escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">base_string</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_oauth_escape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">base_elems</span><span class="p">)</span>
    <span class="n">key_elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">consumer_token</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;~&quot;</span><span class="p">))]</span>
    <span class="n">key_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s2">&quot;secret&quot;</span><span class="p">],</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">token</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_elems</span><span class="p">)</span>

    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">base_string</span><span class="p">),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_base64</span><span class="p">(</span><span class="nb">hash</span><span class="o">.</span><span class="n">digest</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_oauth_escape</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_oauth_parse_response</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="c1"># I can&#39;t find an officially-defined encoding for oauth responses and</span>
    <span class="c1"># have never seen anyone use non-ascii.  Leave the response in a byte</span>
    <span class="c1"># string for python 2, and use utf8 on python 3.</span>
    <span class="n">body_str</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">body_str</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;oauth_token&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">secret</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;oauth_token_secret&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Add the extra parameters the Provider included to the token</span>
    <span class="n">special</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;oauth_token&quot;</span><span class="p">,</span> <span class="s2">&quot;oauth_token_secret&quot;</span><span class="p">)</span>
    <span class="n">token</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">special</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">token</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The Tornado Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>